# 智能pH电极校准功能需求补充v1.6.7

## 架构前提

本章节功能描述基于以下系统架构：

- **智能 pH 电极 (Slave)**：内部集成了pH校准和温度补偿算法。在接收到主控板的进行校准指令后，能够执行校准并计算出斜率百分比和零点偏移（Offset）。 **具体可参照文章后面的补偿算法**。 
- **嵌入式主控板 (Master)**：负责发送校准指令、请求数据、根据内置的合规标准进行判断，并管理整个流程的状态（包括重试和最终成功/失败）。  
- **上位机 (Host Computer )**：承担日志接收、存储与可视化：  
  - **接收与确认**：通过 TCP接收校准日志（JSON/JSON Lines），完成解析与入库。
  - **可视化与追溯**：仪表板展示设备在线状态、校准结果、失败码统计、温度与偏差趋势；支持筛选、审计导出。   
  - **安全与合规**：操作审计、数据保留/备份/归档策略，满足质量与合规要求。

---

## 校准流程（三阶段）

> 本节对 pH 电极校准的**操作性流程**进行统一描述，并与 FR-5/FR-6/FR-7/FR-8.3 的判据与日志机制保持一致。参数阈值均可配置。

### 阶段一：准备与数据采集

- **数据采集**：主控板（Master）持续读取并监控电极的核心参数：**原始 mV**、**当前 pH**、**温度**。  
- **稳定性监控**：在开始每个校准点之前，必须确保电极读数已稳定。  
  - **默认稳定标准**：在最近 **60 s** 内，**mV 漂移 < 1 mV**（或等效的滑动窗口/标准差判据）。  
  - 达到稳定标准后，才会触发后续的校准指令；若在设置的**最长等待时间**内未达标，流程应报超时并进入 FR-7。

### 阶段二：校准执行与参数计算

> 两点校准按顺序进行，温度修正基于缓冲液温度-理论 pH 曲线。

1. **第一点校准**  
   - **操作**：将电极浸入第一个标准缓冲液（如 pH 4.01 或 pH 7.00）。  
   - **系统动作**：  
     - 嵌入式主控板监控pH电极电压稳定性并判定达标；  
     - 嵌入式主控板向电极发送**校准指令的**，指令中的数据包含当前使用的是哪种标准缓冲液，例如1.68/4.00/4.01/7.00/6.86/9.18/10.01/12.45/12.46其中的一种； 
     - 嵌入式主控板等待电极的反馈信号，判断当前点是否校准结束。
     - 记录该点的 **(标准 pH₁, 实际 mV₁, 温度 T₁)**。
2. **第二点校准**  
   - **操作**：将电极浸入第二个标准缓冲液（与第一点有足够 pH 差值，建议 ≥ 3 pH，如 pH 9.18 或 10.01）。  
   - **系统动作**：重复上一步流程，记录 **(标准 pH₂, 实际 mV₂, 温度 T₂)**。
3. **电极内部参数计算**  
   - pH电极使用两点数据自动计算**斜率**与**零点偏移**并形成校准参数；Master 读取**斜率百分比**与 **Offset** 进行 **FR-5** 判定。  （电极计算的是当前温度下的校准参数，同时也会反馈校准时的温度值）
   - （参考关系式，用于质控与追溯）  
     - 斜率 *k*：表示 pH 每变化 1 单位时的 mV 变化量（25 ℃ 理想值约 59.16 mV/pH）；  
     - 线性关系：`pH = k × mV + b`，其中 *b* 为零点偏移。
4. **第三点回测（验证点）**  
   - **操作**：将电极浸入第三个标准缓冲液（如 pH 6.86，区别于前两点）。  
   - **目的**：不参与参数计算，仅用于**验证**前述两点校准的准确性。  
   - **系统动作**：读取当前第三点的 实际pH值和温度值，与回测点的理论 pH值（当前温度，查*Table1*）比较，**计算偏差**，结果用于 **FR-6** 判定。

### 阶段三：验证、质量检查与报告
- **精度验证（FR-6）**：第三点回测 **|测量值 − 理论值| ≤ 0.05 pH**。  
- **质量检查（FR-5）**：  
  - **斜率百分比**在 **90.0% ~ 105.0%**；  
  - **Offset** 在 **−30.0 ~ +30.0 mV**。  
- **判定与处理（FR-7）**：任一项目不合格即进入失败与重试逻辑；重试用尽进入“校准失败”状态。  
- **报告与追溯（FR-8.3）**：上报/拉取**完整日志**（含各校准点记录、温度、斜率%、Offset、回测偏差、重试计数、电极信息等），由上位机**确认 ACK** 后标记送达。

### 一般流程描述

准备 → 采集数据 → 监控稳定 → 点1校准 → 点2校准 → pH电极参数计算 → 第三点回测 → 验证精度 → 质量检查 → 上报/记录

------

<div style="page-break-after: always;"></div>



## FR-5：性能参数请求与判断（Parameter Request and Judgment）

- **描述**：在电极完成内部的两点校准计算后，主控板请求关键性能参数并进行第一轮判断。**此阶段通过是进入验证环节的前提，但并非校准成功的最终条件。**

### 5.1 电极身份识别

- **动作**：在主控板开始整个校准流程时（例如，接收到上位机开始指令后），首先读取电极的序列号、型号和固件版本。
- **目的**：将此信息作为上下文记录，并随所有后续日志上报，用于追溯和电极更换检测。

### 5.2 斜率（Slope）判断

- **动作**：主控板向 pH 电极发送指令，请求获取校准后的斜率百分比（即 *实测斜率 / 理论斜率 × 100%*）。
- **判断**：主控板将接收到的斜率百分比，与自身固件中存储的合格范围（**90.0% ~ 105.0%**）进行比较。
- **失败处理**：若超出范围，主控板记录失败原因（例如：`FAIL_CODE_SLOPE_LOW`），并立即转至 **FR-7 失败与重试逻辑**。

### 5.3 零电位（Offset）判断

- **动作**：主控板向 pH 电极发送指令（同5.2请求斜率可以一条指令，**这条指令也可返回校准时的温度值**），请求获取校准后的零点漂移 Offset（单位 mV）。
- **判断**：主控板将接收到的 Offset 值，与自身存储的合格范围（**-30.0 mV ~ +30.0 mV**）进行比较。*（注：此范围基于当前电极规格设定，如需调整可通过上位机配置）*
- **失败处理**：若超出范围，主控板记录失败原因（例如：`FAIL_CODE_OFFSET_HIGH`），并立即转至 **FR-7 失败与重试逻辑**。

---

## FR-6：回测（验证）流程（Verification Process）

### FR-6.2 温度补偿与 pH 换算（在智能pH电极中实现）

**目标**：在“测量温度” \(T\) 下，用最近一次校准得到的 **slope%** 与 **offset**（以 \(pH=7\) 时的电位 \(E_7\) 表示），把当前测得的电位 \(E\)（mV）换算为 pH。

#### 一、公式（最简）
1) 理想 Nernst 斜率（mV/pH）  
$$
S_{ideal}(T)=59.16\times \frac{T+273.15}{298.15}
$$
> \(T\) 以 **℃** 计；59.16 是 **25℃** 时的理想斜率（mV/pH）。

2) 实际斜率（考虑电极效率）  
$$
S(T)=\frac{\text{slope\%}}{100} \times S_{ideal}(T)
$$

3) pH 计算  
$$
\boxed{\;pH=7-\frac{E-E_7}{S(T)}\;}
$$

**符号/单位**：  
- \(T\)：当前测量温度（℃）  
- \(E\)：当前样品电位（mV）  
- \(E_7\)：校准得到的“pH=7 电位”（mV，常称 *offset*）  
- \(\text{slope\%}\)：校准得到的斜率百分比（如 98 表示 98%）  
- \(S_{ideal}(T), S(T)\)：斜率（mV/pH）

#### 二、工程实现（一步步）
```text
输入：T(℃), E(mV), slope_percent(%), E7(mV)

S_ideal = 59.16 * ( (T + 273.15) / 298.15 )
S       = (slope_percent / 100.0) * S_ideal
dE      = E - E7
pH      = 7.0 - dE / S
```

> 合理性检查：当样品是 pH7 缓冲液时，测得 \(E \approx E_7\) ⇒ \(dE\approx 0\) ⇒ \(pH\approx 7\)。

#### 三、数值例子
- 校准结果：`slope% = 98`，`E7 = +2 mV`  
- 本次测量：`T = 30 ℃`，`E = -120 mV`  
计算：  
- `S_ideal ≈ 59.16 * ((30 + 273.15)/298.15) ≈ 60.15 mV/pH`  
- `S ≈ 0.98 * 60.15 ≈ 58.95 mV/pH`  
- `dE = -120 - 2 = -122 mV`  
- `pH = 7 - (-122)/58.95 ≈ 9.07`（碱性）

#### 四、实施备注与防错
- **offset 定义**：默认 offset 即 \(E_7\)（pH7 的电位）。若设备把 offset 定义为 \(E_0\)（pH=0 截距，少见），则应改用 `pH = (E - E0) / S(T)`。  
- **温度取值**：**始终使用“当前实时温度”** 计算斜率，不要沿用“校准时温度”。  
- **阈值建议**：`90% ≤ slope% ≤ 105%`，`|E7| ≤ 30 mV`（经验阈值，越界提示换电极/重校）。

#### 五、寄存器映射（实现对照）
- **E (mV)**：`0x1100–0x1101`  
- **pH（若电极已计算）**：`0x1102–0x1103`  
- **T (℃)**：`0x1104–0x1105`  
- **校准参数组（含 slope%、E7 等）**：自 **`0x1130`** 起（以通信示例为准）  
- **保存校准**：写 `0x0101 = 0x3535`；**回滚理论状态**：写 `0x0101 = 0x35AC`


**描述**：在斜率和零电位判断通过后，主控板引导系统进入验证流程。**此环节是校准成功的最终且强制性关口，即使FR-5通过，本环节失败则校准失败。**

### 6.1 状态切换与缓冲液识别

- 主控板进入“**等待验证液**”状态。
- 系统需明确当前使用的验证液种类（例如，通过上位机指令指定或RFID识别）。**本系统默认使用 pH 6.86 （可更改）的磷酸盐标准缓冲液进行验证。**

### 6.2 数据请求

- 机械臂将电极放入验证液。
- 主控板周期性地向 pH 电极发送指令，请求当前 pH 读数。此时，pH智能电极应使用本次校准后的新参数来计算并返回 pH 值。（**是经过校准时的温度补偿值**）

### 6.3 回测偏差判断

- 主控板记录pH电极校准时测得的温度，然后计算出回测校准液在该温度下的**理论 pH 值**（温度补偿）。根据**Table1*做差值计算  （具体看选择哪一种校准液作为回测液）
- 主控板计算偏差：**偏差 =（接收到的 pH 读数 − 理论 pH 值）**。  
- 主控板判断该偏差的绝对值是否 **≤ 0.05 pH**。  

- 失败处理：若偏差超限，主控板记录失败原因（`FAIL_CODE_VERIFY_DEVIATION`），并转至 **FR-7 失败与重试逻辑**。

**Table1 校准液理论pH表格**

| 温度 (°C) | 草酸盐标准缓冲液 | 邻苯二甲酸氢钾标准缓冲液 | 磷酸盐标准缓冲液 | 硼砂标准缓冲液 | 氢氧化钙标准缓冲液（25℃饱和溶液） |
| :-------: | :--------------: | :----------------------: | :--------------: | :------------: | :-------------------------------: |
|     0     |       1.67       |           4.01           |       6.98       |      9.46      |               13.43               |
|     5     |       1.67       |           4.00           |       6.95       |      9.40      |               13.21               |
|    10     |       1.67       |           4.00           |       6.92       |      9.33      |               13.00               |
|    15     |       1.67       |           4.00           |       6.90       |      9.27      |               12.81               |
|    20     |       1.68       |           4.00           |       6.88       |      9.22      |               12.63               |
|    25     |       1.68       |           4.01           |       6.86       |      9.18      |               12.45               |
|    30     |       1.68       |           4.01           |       6.85       |      9.14      |               12.30               |
|    35     |       1.69       |           4.02           |       6.84       |      9.10      |               12.14               |
|    40     |       1.69       |           4.04           |       6.84       |      9.06      |               11.98               |
|    45     |       1.70       |           4.05           |       6.83       |      9.04      |               11.84               |
|    50     |       1.71       |           4.06           |       6.83       |      9.01      |               11.71               |
|    55     |       1.72       |           4.08           |       6.83       |      8.99      |               11.57               |
|    60     |       1.72       |           4.09           |       6.84       |      8.96      |               11.45               |

---

### FR-6.6 零点（截距）与温度的处理原则（更新）

**默认策略**  

- 测量阶段沿用最近一次校准得到的零点/截距（**E7** 或 **E0**），不随温度改写；温度的一阶影响通过 **S(T_now)**（Nernst 斜率）来补偿。  
- 换算公式：  
  - 以 **E7** 口径存储零点时：`pH = 7 - (E - E7) / S(T_now)`  
  - 以 **E0** 口径存储零点时：`pH = (E - E0) / S(T_now)`  
    其中 `S(T_now) = η · S_ideal(T_now)`，`S_ideal(T) = 59.16 * (T + 273.15) / 298.15` (mV/pH)。

**何时复核/更新零点（可选，临时手段）**  

- **优先原则**：若现场条件允许（有缓冲液、可停机、合规窗口开放），**直接执行两点重校**，不建议仅调整零点。  
- **仅当暂时无法重校**（产线连续、样品测量不可中断、现场缺耗材/人手）且排除温度探头异常、缓冲液问题、明显的斜率异常时，方可采用“快速零点估计”做**临时修正**：  
  - 在当前温度 `T_now` 用**已知 pH 缓冲液**测得电位 `E_meas`，查表得 `pH_ref(T_now)`；  
  - 计算 `S(T_now)`（按分支 A 或 B），估计新零点：  
    `E7_est = E_meas + S(T_now) * ( pH_ref(T_now) - 7 )`  
  - 若 `|E7_est - E7| > 5–10 mV` 且**多次复测稳定**，可在系统中记录“**临时零点修正**”，并将 `E7 := E7_est`；同时自动创建**重校任务**，在最早可行时段执行**两点重校**并覆盖该临时修正。  
- **禁止情形**：`slope_percent` 超界或显著波动、回测呈**非平移型**误差、或任何硬件/介质异常未排除 → **不得仅改零点，必须两点重校**。  
- **审计要求**：临时修正需在日志中标记原因、操作者/时间、原值/新值，并在后续重校完成后**关闭临时状态**。


**典型适用场景（示例）**  

- **温差较大**：`|T_now - Tc| > 10–15 °C`，且当前方法/法规对零点误差有更严格要求（如 `|ΔpH| ≤ 0.02`）。  
- **连续生产不可停机**：当班需将偏差先拉回控制限内；`slope_percent` 正常、温度探头自检正常、噪声/漂移可控。  
- **近似“平移型”偏差**：连续多批样品的 `(pH_meas - pH_ref(T_now))` 近似为**常数**；酸端/碱端误差对称。  
- **QC 复核提示零点平移**：标准样复测显示整体偏移，且短时内需要进入关键工序，允许临时兜底。

**不适用场景（示例，直接两点重校）**  

- `slope_percent` 超界或显著波动（斜率型误差）。  
- 酸端/碱端误差**不对称**（非平移型偏差）。  
- 温度探头异常、缓冲液过期/污染、膜破/参比问题等硬件或介质异常未排除。
  **阈值与告警（建议）**  
- `90% ≤ slope_percent ≤ 105%`；`|E7| ≤ 30 mV`；零点漂移监控采用“滑窗均值 + 抖动抑制”再判阈值。  
- 发现突变先排查：电极污染/老化、参比盐桥问题、接线与接地、温度探头异常。

**例外（电极直接输出 pH）**  

- 若电极本身输出的是 pH（非 mV），其内部已按**实时温度**与最近校准参数完成换算。此时直接读取 pH 即可，主控板无需另行处理截距/斜率。

------



## FR-7：失败与重试逻辑（Failure and Retry Logic）

**描述**：当任何一项核心指标不合格时，主控板应启动内部的失败处理和重试机制。

### 7.1 重试计数器
主控板内置一个重试计数器，初始值为 **2**。

### 7.2 失败时的动作

- 记录具体的内部失败代码；  
- 通过接口输出失败状态（例如，特定的错误码）；  
- 进入“**等待重试指令**”状态。

### 7.3 接收到重试指令后的动作
当接收到重试指令后，主控板将重试计数器减 **1**，并向电极发送指令，从头开始一个新的校准周期。

### 7.4 重试用尽后的处理

如果所有重试次数均用尽后仍然失败，主控板应：
- 进入永久性“**校准失败**”状态。此状态只能通过系统复位或特定的“**强制清除错误**”（`FORCE_CLEAR_FAILURE`）指令来解除。该指令应由授权管理员在确认问题已解决（如更换电极）后手动触发。
- 输出一个明确的、最终的失败状态码和日志。

- ### 换电极后的复位流程

  1. **物理更换与准备**：更换电极，并进行必要的活化与稳定。
  2. **状态清除**：由上位机向处于“校准失败”状态的主控板下发 `FORCE_CLEAR_FAILURE` 指令。
  3. **系统复位**：主控板接收到指令后，执行以下操作：
     - 退出“校准失败”状态。
     - **重置重试计数器**为初始值（2）。
     - 清空内部所有临时校准数据和阶段标志。
  4. **新电极识别**：在下次校准开始时，主控板将自动读取并上报新电极的身份信息（见FR-5.1），上位机据此记录电极更换事件。

---

## FR-8.3：日志传输与数据可靠性

**描述**：在校准流程的各个关键节点（成功/失败），主控板必须将完整的日志记录安全、可靠地传输到指定的上位机。

### 8.3.1 数据包通用格式（General Packet Format）

- **动作**：主控板必须将校准结果打包成结构化的 **JSON** 格式进行传输。
- **通用字段**：所有日志数据包必须包含以下字段：
  - **时间戳（timestamp）**：事件发生的精确时间，格式为 `YYYY-MM-DDTHH:MM:SSZ`（ISO 8601）。
  - **设备唯一标识符（device_id）**：用于区分不同的 pH 计。
  - **事件类型（event_type）**：`"CalibrationLog"` 或 `"CalibrationFailed"`。
  - **电极信息（electrode_info）**：包含 `sn`（序列号），`model`（型号），`fw_ver`（固件版本）。

### 8.3.2 成功日志格式（Success Log Format）

当 `event_type` 为 `"CalibrationLog"` 且 `status` 为 `"Success"` 时，`data` 对象必须包含：

json

```
{
  "timestamp": "2025-09-28T22:35:00Z",
  "device_id": "PHM-00123",
  "event_type": "CalibrationLog",
  "electrode_info": {
    "sn": "PH123456",
    "model": "XYZ-ABC",
    "fw_ver": "1.2.3"
  },
  "status": "Success",
  "data": {
    "temperature_c": 26.2,
    "slope_percent": 99.7,
    "offset_mv": -2.5,
    "verification_error_ph": 0.01,
    "retry_count": 0,
    "calibration_points": [
      {"buffer_ph": 7.00, "measured_mv": -5.1},
      {"buffer_ph": 4.00, "measured_mv": 177.2}
    ]
  }
}
```



### 8.3.3 失败日志格式（Failure Log Format）

当 `event_type` 为 `"CalibrationFailed"` 时，`data` 对象必须包含：

json

```
{
  "timestamp": "2025-09-28T22:34:00Z",
  "device_id": "PHM-00123",
  "event_type": "CalibrationFailed",
  "electrode_info": {
    "sn": "PH123456",
    "model": "XYZ-ABC",
    "fw_ver": "1.2.3"
  },
  "status": "Failed",
  "data": {
    "fail_code": "FAIL_CODE_SLOPE_LOW",
    "fail_stage": "SLOPE_CHECK",
    "retries_remaining": 1
  }
}
```



### 8.3.4 传输协议与确认机制（Transmission Protocol and Acknowledgement）

- **网络角色**：**上位机作为控制中心，以TCP客户端身份主动连接主控板，下发`开始校准`等指令，并接收主控板返回的校准结果与日志。**

- **协议**：使用 **TCP** 协议，以保证数据传输的可靠性和顺序性。

- **确认机制**：上位机在成功接收、解析并存储日志数据后，必须向主控板发送一个确认回执（**ACK**）消息。ACK建议为JSON格式：`{"status": "ack", "received_log_id": "12345"}`。主控板只有在收到此 ACK 后，才能认为该条日志已成功记录。应实现超时重传机制以应对网络异常。

  

------

<div style="page-break-after: always;"></div>

------



#### 附录：智能pH电极补偿算法

智能pH电极软件算法是补偿的核心，它在**校准**和**测量**两个阶段分别起作用：

**阶段 A: 在校准时**                                             

这是实现精确补偿的**最关键步骤**。我们之前讨论的需求文档中的流程，正是基于此。

1. **获取实时温度 (T)**: 软件从ATC传感器读取当前的溶液温度，例如 `28.0°C`。
2. **校正缓冲液pH值**: 当提示用户放入pH 4.01缓冲液时，智能pH电极软件会查询内部存储的“缓冲液温度-pH对照表”，找到pH 4.01缓冲液在 `28.0°C` 时的**真实理论pH值**，比如是 `4.02`。
3. **建立数据对**: 软件测量此时电极的毫伏读数 `mV_1`。于是它得到了第一个精确的校准数据对：`(pH 4.02, mV_1)`。
4. **重复过程**: 对第二种缓冲液（如pH 9.18）也执行同样的操作，得到第二个数据对，例如 `(pH 9.13, mV_2)`。
5. **计算实际斜率**: 软件利用这两个经过了温度补偿的精确数据对，计算出电极**在当前28.0°C下的实际工作斜率**和截距。
   - `Slope_actual = (mV_2 - mV_1) / (9.13 - 4.02)`
   - 这个计算出的 `Slope_actual` 自然地反映了电极在28.0°C时的真实响应度。

**阶段 B: 在测量时**

1. **获取实时数据**: 软件测量未知样品的毫伏读数 `mV_sample`。
2. **应用校准参数**: 软件使用**在校准阶段计算出的** `Slope_actual` 和截距，来将 `mV_sample` 转换为最终的pH值。
   - `pH_final = (mV_sample - Intercept) / Slope_actual`

因为 `Slope_actual` 本身就是在特定温度下、基于精确的理论pH值得出的，所以用它来计算样品的pH值，就**自动地、隐式地**完成了对电极斜率的温度补偿。

### 总结

简单来说，温度补偿的实现流程就是：

1. **用ATC探头实时测量温度。**
2. **校准时**：根据实时温度，查表修正标准缓冲液的理论pH值，然后用这个修正值去计算电极的**实际斜率**。
3. **测量时**：用这个在特定温度下得到的**实际斜率**，将样品的mV读数转换成最终的pH值。

通过这个闭环过程，仪器就能够确保无论是在15°C还是35°C进行测量，都能得到准确可靠的pH读数。

------

<div style="page-break-after: always;"></div>

## **针对三信pH电极的控制逻辑说明**

### **主控板与三信pH电极的完整校准交互流程 (增强版)**

**核心思想**：由嵌入式主控板（Master）作为主导，智能pH电极（Slave）作为执行者。校准结果读取指令用于在两点校准后立即进行一次“健全性检查 (Sanity Check)”。



### **校准前准备 (Step 0)**

1. **逻辑处理**: 在正式开始校准前，主控板应获取电极的身份信息，用于日志记录和追溯。
2. **通信交互**:
   - 主控板向电极发送 **Modbus读指令 (03H)**，读取寄存器 `0010H-0015H` 获取**序列号**。
   - 主控板发送 **Modbus读指令 (03H)**，读取寄存器 `0018H-0019H` 获取**硬件和软件版本**。
   - 主控板将这些信息保存在内存中，待后续生成日志时使用。



### **阶段一：启动与稳定性监控 (Step 1)**

**逻辑处理**: 主控板接收到上位机的“开始校准”指令。首先，必须确认电极当前处于空闲状态，然后等待电极读数稳定。

1. **通信交互**:
   - **查询状态**: 主控板发送 **Modbus读指令 (03H)**，读取状态寄存器 `0100H`。
   - **逻辑判断**: 主控板检查返回值是否为 `1` (测量状态)。
   - **监控稳定**: 主控板进入循环，每隔几秒就发送 **Modbus读指令 (03H)** 读取mV值寄存器 `1100H-1101H`。
   - **逻辑判断**: 主控板在内部实现稳定性算法（例如，60秒内mV读数变化小于1mV）。



### **阶段二：两点校准执行 (Step 2)**

1. **逻辑处理 (第一点)**: 待第一种缓冲液（例如 pH 7.00）的读数稳定后，主控板正式向电极发起该点的校准。
2. **通信交互 (第一点)**:
   - 主控板发送 **Modbus写指令 (06H)**，将第一种缓冲液的标称pH值（例如 `700`）写入校准寄存器 `1120H`。
   - 主控板**轮询**状态寄存器 `0100H`，直到其值从 `2` (校准中) 变回 `1` (测量)，表示第一点校准完成。
3. **逻辑处理 & 通信交互 (第二点)**: 主控板重复**阶段一的稳定性监控**和**阶段二的校准执行**，但这次是针对第二种缓冲液（例如 pH 4.01）。



### **阶段三：流程健全性检查 (Sanity Check) - (新增步骤)**

1. **逻辑处理**: 在两点校准命令都发送完毕后，主控板立即验证电极是否正确理解并执行了操作。
2. **通信交互**:
   - 主控板发送 **Modbus读指令 (03H)**，读取**校准结果**寄存器 `1121H`。
   - 电极返回一个两字节的状态码。
3. **逻辑判断**:
   - **检查点数**: 主控板检查返回值的**高位字节**是否为 `0x02`，确认电极记录的是**两点**校准。
   - **检查标液组合**: 主控板检查返回值的**低位字节**是否为预期的组合码（例如，对于pH 7.00和4.01，预期值为 `0x06`）。
   - **失败处理**: **任何一项不匹配**，都意味着流程中出现了意外错误。主控板应记录失败原因（例如 `FAIL_CODE_SANITY_CHECK_MISMATCH`），并立即跳转至 **“失败与重试逻辑” (Step 6)**。



### **阶段四：参数判断与回测验证 (Step 4)**

1. **逻辑处理**: 如果健全性检查通过，主控板继续进行定量的性能参数判断。
2. **通信交互 (参数判断)**:
   - 主控板发送 **Modbus读指令 (03H)**，读取电极的校准数据寄存器 `1130H` 及之后地址，获取**校准温度**、**零点 (Offset)** 和**斜率百分比 (Slope %)**。
   - **逻辑判断**:
     - 判断返回的 **Slope %** 是否在 `90.0% ~ 105.0%` 范围内。
     - 判断返回的 **Offset** 是否在 `-30.0 mV ~ +30.0 mV` 范围内。
     - **任一失败**，流程跳转至 **“失败与重试逻辑” (Step 6)**。
3. **逻辑处理 & 通信交互 (回测验证)**:
   - **如果上述判断通过**，主控板进入回测流程。
   - 把pH电极放入第三种缓冲液，主控板再次执行**阶段一的稳定性监控**。
   - 稳定后，主控板发送 **Modbus读指令 (03H)**，读取**当前pH读数** (`1102H`) 和**当前温度** (`1104H`)。
   - **逻辑判断**:
     - 主控板根据刚读取的**当前温度**，查阅内部的`Table1`，计算出验证液的**理论pH值**。
     - 计算偏差：`| 读取的pH值 - 理论pH值 |`，并判断是否 `≤ 0.05 pH`。
     - **如果失败**，流程跳转至 **“失败与重试逻辑” (Step 6)**。

### **阶段五：流程结束 (Step 5)**

1. **逻辑处理 (成功)**: 如果所有判断都通过，则校准成功。
2. **通信交互 (成功)**:
   - 主控板向电极发送 **Modbus写指令 (06H)**，将**保存指令 `0x3535`** 写入寄存器 `0101H`。
   - 主控板整理**成功日志**，通过网口发送给上位机，并等待ACK确认。

### **失败与重试逻辑 (Step 6)**



1. **逻辑处理**: 在阶段三或四的任一判断失败后，主控板进入此逻辑。
2. **通信交互**:
   - **如果可以重试**: 发送**失败日志**，等待重试指令，然后**返回 Step 1**。
   - **如果重试用尽**: 发送**最终失败日志**，并向电极发送**恢复理论状态指令 `0x35AC`** (`0101H`)，进入锁定状态。

### 备注

校准结果：**寄存器地址：1121H **，推测性解释：

在这个设计中，寄存器的一个字节（8位）中的每一位（bit）都被分配给一个特定的标准缓冲液。当某个缓冲液被用于校准时，对应的位就被设置为 `1`。

**1. 假设的解码表**

我们可以根据手册中列出的标准溶液，为低位字节的每一位创建一个假设的对应关系：

| 位 (Bit)  | 二进制值        | 十进制值 | 代表的缓冲液 (推测) |
| --------- | --------------- | -------- | ------------------- |
| Bit 0     | `0000 0001`     | 1        | pH 1.68             |
| **Bit 1** | **`0000 0010`** | **2**    | **pH 4.00 / 4.01**  |
| **Bit 2** | **`0000 0100`** | **4**    | **pH 6.86 / 7.00**  |
| Bit 3     | `0000 1000`     | 8        | pH 9.18             |
| Bit 4     | `0001 0000`     | 16       | pH 10.01            |
| Bit 5     | `0010 0000`     | 32       | pH 12.45 / 12.46    |
| Bit 6     | `0100 0000`     | 64       | (备用)              |
| Bit 7     | `1000 0000`     | 128      | (备用)              |

**2. 解码过程**

现在，我们来看一下手册中返回的值 `06`（十六进制）：

- **步骤 1: 转换为二进制** 十六进制的 `06` 转换为二进制是 `0000 0110`。
- **步骤 2: 查看哪些位被设为 "1"** 在 `0000 0110` 中，**Bit 1** 和 **Bit 2** 被设置成了 `1`。
- **步骤 3: 查找对应的缓冲液** 根据我们上面假设的表格：
  - Bit 1 (`...010...`) ➞ 代表 **pH 4.00 / 4.01**
  - Bit 2 (`...100...`) ➞ 代表 **pH 6.86 / 7.00**
- **步骤 4: 组合结果** 因为 Bit 1 和 Bit 2 同时被激活，所以这个值代表了 **pH 4.00 和 pH 7.00** 这两种缓冲液都被用于校准。

从数值上看，就是将激活的位的十进制值相加：`2` (代表pH 4.00) + `4` (代表pH 7.00) = `6`。
