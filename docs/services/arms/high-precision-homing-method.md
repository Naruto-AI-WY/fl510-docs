# 高精度回零方法：挡片中心定位法详解



## 1. 方法概述

“挡片中心定位法”（Block Center-Finding Method）是一种旨在找到物理挡片（或光电开关U型槽）**几何中心点**并将其设为机器零点的高精度回零方法。

与寻找单个边沿的“单边沿精定位法”不同，此方法通过精确测量挡片两侧边缘的位置，然后通过计算得出中心点。其核心优势在于能够提供更高的**绝对定位精度**，即零点位置更接近真实的物理中心。

## 2. 适用场景

这种方法特别适用于以下场景：

- **对称性要求高**：当后续的加工或操作需要严格围绕一个物理特征的中心进行时。
- **传感器漂移补偿**：当担心光电传感器的触发点可能因温度或老化产生微小漂移时，此方法可以有效抵消这种漂移带来的误差。
- **绝对位置校准**：用于对机器的绝对坐标系进行初始标定。

## 3. 系统参数设定 (示例)

为了详细说明计算过程，我们设定一套具体的系统参数：

- **电机类型**：闭环步进电机（带编码器）
- **步进参数**：每转 `200` 步，驱动器设置为 `8` 微步，即 **`1600` 步/转 (steps/rev)**。
- **编码器参数**：每转 `1000` 线，4倍频后为 **`4000` 计数/转 (counts/rev)**。
- **机械传动**：滚珠丝杠导程为 **`5 mm/转`**。

#### 分辨率计算：

- **指令分辨率**：`5 mm / 1600 steps = 0.003125 mm/step`
- **反馈分辨率**：`5 mm / 4000 counts = 0.00125 mm/count` (这是我们进行精确计算的基础)

## 4. 详细执行流程

控制器将严格按照以下流程执行，每一步都涉及精确的动作和内部计算。

### **阶段一：寻找第一边沿 (P1)**

**目标：精确锁定挡片左侧边缘的位置。**

- **动作**：
  1. 轴以一个安全的中低速向左移动（负方向）。
  2. 当挡片进入光电传感器，使信号状态从 `OFF` 变为 `ON` 的瞬间，硬件锁存功能被触发。
  3. 控制器记录下锁存的编码器位置 `P1`，然后电机减速停止。
- **控制器内部计算/状态**：
  1. 控制器激活硬件锁存电路，并监控传感器输入端口。
  2. 传感器信号触发，锁存电路瞬间捕获当时的编码器计数值。
  3. **得到第一个精确位置**：`P1`。
  4. **示例**：假设锁存到的值为 `P1 = -150,225` counts。

### **阶段二：穿过挡片**

**目标：使轴完全移动到挡片的另一侧，为寻找第二边沿做准备。**

- **动作**：
  1. 电机继续以低速向左移动。
  2. 控制器监控传感器信号，直到其从 `ON` 变为 `OFF`，这表示挡片已经完全离开了传感器。
  3. 为确保完全脱离，电机可以再额外向左移动一小段安全距离后停止。
- **控制器内部计算/状态**：
  1. 此阶段的核心是状态判断，等待 `Home_Signal == OFF`。
  2. 不需要进行位置锁存或复杂计算。

### **阶段三：寻找第二边沿 (P2)**

**目标：从相反方向精确锁定挡片右侧边缘的位置。**

- **动作**：
  1. 轴现在以与阶段一**完全相同**的低速，**反向**（向右，正方向）移动。
  2. 当挡片再次进入传感器，使信号状态从 `OFF` 变为 `ON` 的瞬间，硬件锁存再次被触发。
  3. 控制器记录下锁存的编码器位置 `P2`，然后电机减速停止。
- **控制器内部计算/状态**：
  1. 控制器再次激活硬件锁存电路。
  2. 传感器信号触发，锁存电路捕获当前的编码器计数值。
  3. **得到第二个精确位置**：`P2`。
  4. **示例**：假设挡片的物理宽度为 `2mm`。
     - 宽度对应的编码器计数值 = `2 mm / 0.00125 mm/count = 1600` counts。
     - 理论上 `P2` 应该约等于 `P1 + 1600`。
     - 假设锁存到的值为 `P2 = -148,625` counts。

### **阶段四：计算中心点并设定零位**

**目标：根据 `P1` 和 `P2` 计算出中心点，并建立机器坐标系。**

- **动作**：

  1. 电机保持停止状态。
  2. 控制器在内部执行计算。

- **控制器内部计算/状态**：

  1. **执行核心计算**：控制器读取 `P1` 和 `P2` 的值，并计算它们的平均值。

     $$P_{zero} = \frac{P_1 + P_2}{2}$$

  2. **示例计算**：

     $$P_{zero} = \frac{(-150,225) + (-148,625)}{2} = \frac{-298,850}{2} = -149,425 \text{ counts}$$

     *注意：在实际控制器中，这通常通过整数加法和一次位移（右移一位 `>> 1`，等效于除以2）来高效完成。如果结果有小数（即和为奇数），通常会向下取整，`0.5`个计数的误差（在此例中为 `0.000625 mm`）完全可以忽略不计。*

  3. **设定零点**：

     - 控制器将内部的**绝对位置编码器计数器**（Absolute Encoder Counter）设置为 `0`。
     - 同时，它会创建一个**偏移量（Offset）**，`Offset = -P_zero = 149,425`。
     - 从此以后，任意一个逻辑位置 `P_logic` 对应的真实编码器目标值将是 `P_encoder_target = P_logic + P_zero`。或者说，控制器显示的当前位置 `P_display` 将是 `P_encoder_current + Offset`。

  4. **回零完成！** 机器现在有了一个以物理挡片几何中心为基准的、高绝对精度的零点。

## 5. 优缺点分析

### **优点**

- **高绝对精度**：零点非常接近挡片的真实物理中心，不受挡片宽度和传感器触发点固定偏差的影响。
- **抗传感器漂移**：如果传感器的触发点整体向左或向右漂移，`P1` 和 `P2` 会同向移动相同的量，计算出的中心点 `(P1+P2)/2` 保持不变。

### **缺点**

- **重复定位精度可能稍低**：由于 `P1` 和 `P2` 是从**相反方向**逼近得到的，机械传动链中的**背隙（Backlash）**会引入变量。这可能导致重复执行回零时，得到的 `P_zero` 有微小的波动，从而影响重复定位精度。
- **耗时更长**：相比单边沿法，此方法需要两次低速精确扫描，整个回零过程耗时更长。
- **逻辑更复杂**：对控制器的编程和固件要求更高。