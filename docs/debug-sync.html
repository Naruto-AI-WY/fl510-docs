<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置同步调试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔧 配置同步调试工具</h1>
    
    <div class="test-section">
        <h3>1. 基础检查</h3>
        <button class="test-button" onclick="checkBasics()">检查基础</button>
        <div id="basics-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Token测试</h3>
        <input type="password" id="test-token" placeholder="输入GitHub Token" style="width: 300px; padding: 5px;">
        <button class="test-button" onclick="testToken()">测试Token</button>
        <div id="token-result"></div>
    </div>

    <div class="test-section">
        <h3>3. 配置同步测试</h3>
        <button class="test-button" onclick="testSync()">测试同步</button>
        <button class="test-button" onclick="testLoad()">测试加载</button>
        <div id="sync-result"></div>
    </div>

    <div class="test-section">
        <h3>4. 用户配置测试</h3>
        <button class="test-button" onclick="addTestUser()">添加测试用户</button>
        <button class="test-button" onclick="showConfig()">显示配置</button>
        <div id="config-result"></div>
    </div>

    <div class="test-section">
        <h3>5. 调试信息</h3>
        <button class="test-button" onclick="showDebug()">显示调试信息</button>
        <div id="debug-result"></div>
    </div>

    <!-- 加载脚本 -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/config-sync.js"></script>

    <script>
        function showResult(elementId, message, type = 'info') {
            document.getElementById(elementId).innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkBasics() {
            let result = '基础检查结果：<br>';
            
            result += `window.AUTH_CONFIG: ${!!window.AUTH_CONFIG}<br>`;
            result += `window.configSync: ${!!window.configSync}<br>`;
            result += `configSync.initialized: ${window.configSync?.initialized}<br>`;
            result += `localStorage配置: ${!!localStorage.getItem('fl510_docs_config')}<br>`;
            result += `GitHub Token: ${!!localStorage.getItem('github_sync_token')}<br>`;
            result += `Gist ID: ${!!localStorage.getItem('fl510_gist_id')}<br>`;
            
            showResult('basics-result', result, 'info');
        }

        async function testToken() {
            const token = document.getElementById('test-token').value.trim();
            if (!token) {
                showResult('token-result', '请输入Token', 'error');
                return;
            }

            showResult('token-result', '正在测试Token...', 'info');

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    showResult('token-result', `✅ Token有效！用户: ${user.login}`, 'success');
                    
                    // 保存Token
                    localStorage.setItem('github_sync_token', token);
                    if (window.configSync) {
                        window.configSync.githubToken = token;
                    }
                } else {
                    showResult('token-result', `❌ Token无效，状态码: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('token-result', `❌ 网络错误: ${error.message}`, 'error');
            }
        }

        async function testSync() {
            showResult('sync-result', '正在测试同步...', 'info');
            
            try {
                if (window.configSync && window.configSync.syncConfig) {
                    await window.configSync.syncConfig();
                    showResult('sync-result', '✅ 同步测试完成', 'success');
                } else {
                    showResult('sync-result', '❌ configSync不可用', 'error');
                }
            } catch (error) {
                showResult('sync-result', `❌ 同步失败: ${error.message}`, 'error');
            }
        }

        async function testLoad() {
            showResult('sync-result', '正在测试加载...', 'info');
            
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        showResult('sync-result', `✅ 加载成功: ${JSON.stringify(config)}`, 'success');
                    } else {
                        showResult('sync-result', '⚠️ 没有云端配置', 'info');
                    }
                } else {
                    showResult('sync-result', '❌ configSync不可用', 'error');
                }
            } catch (error) {
                showResult('sync-result', `❌ 加载失败: ${error.message}`, 'error');
            }
        }

        function addTestUser() {
            try {
                // 获取当前配置
                let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                if (!config.allowedUsers) config.allowedUsers = [];
                if (!config.adminUsers) config.adminUsers = [];

                // 添加测试用户
                const testUser = 'test-user-' + Date.now();
                config.allowedUsers.push(testUser);
                
                // 保存配置
                localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                
                // 更新全局配置
                if (window.AUTH_CONFIG) {
                    window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
                }

                showResult('config-result', `✅ 添加测试用户: ${testUser}`, 'success');
            } catch (error) {
                showResult('config-result', `❌ 添加用户失败: ${error.message}`, 'error');
            }
        }

        function showConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                showResult('config-result', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
            } catch (error) {
                showResult('config-result', `❌ 显示配置失败: ${error.message}`, 'error');
            }
        }

        function showDebug() {
            let debug = '调试信息：<br><pre>';
            
            debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
            debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
            debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
            
            // 检查各个方法
            if (window.configSync) {
                debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
                debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
                debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
                debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
            }
            
            debug += '</pre>';
            showResult('debug-result', debug, 'info');
        }

        // 页面加载时自动检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkBasics();
            }, 1000);
        });
    </script>
</body>
</html>
