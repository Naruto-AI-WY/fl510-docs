<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®åŒæ­¥è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .test-button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é…ç½®åŒæ­¥è°ƒè¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>1. åŸºç¡€æ£€æŸ¥</h3>
        <button class="test-button" onclick="checkBasics()">æ£€æŸ¥åŸºç¡€</button>
        <div id="basics-result"></div>
    </div>

    <div class="test-section">
        <h3>2. Tokenæµ‹è¯•</h3>
        <input type="password" id="test-token" placeholder="è¾“å…¥GitHub Token" style="width: 300px; padding: 5px;">
        <button class="test-button" onclick="testToken()">æµ‹è¯•Token</button>
        <div id="token-result"></div>
    </div>

    <div class="test-section">
        <h3>3. é…ç½®åŒæ­¥æµ‹è¯•</h3>
        <button class="test-button" onclick="testSync()">æµ‹è¯•åŒæ­¥</button>
        <button class="test-button" onclick="testLoad()">æµ‹è¯•åŠ è½½</button>
        <div id="sync-result"></div>
    </div>

    <div class="test-section">
        <h3>4. ç”¨æˆ·é…ç½®æµ‹è¯•</h3>
        <button class="test-button" onclick="addTestUser()">æ·»åŠ æµ‹è¯•ç”¨æˆ·</button>
        <button class="test-button" onclick="showConfig()">æ˜¾ç¤ºé…ç½®</button>
        <div id="config-result"></div>
    </div>

    <div class="test-section">
        <h3>5. è°ƒè¯•ä¿¡æ¯</h3>
        <button class="test-button" onclick="showDebug()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="debug-result"></div>
    </div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/config-sync.js"></script>

    <script>
        function showResult(elementId, message, type = 'info') {
            document.getElementById(elementId).innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkBasics() {
            let result = 'åŸºç¡€æ£€æŸ¥ç»“æœï¼š<br>';
            
            result += `window.AUTH_CONFIG: ${!!window.AUTH_CONFIG}<br>`;
            result += `window.configSync: ${!!window.configSync}<br>`;
            result += `configSync.initialized: ${window.configSync?.initialized}<br>`;
            result += `localStorageé…ç½®: ${!!localStorage.getItem('fl510_docs_config')}<br>`;
            result += `GitHub Token: ${!!localStorage.getItem('github_sync_token')}<br>`;
            result += `Gist ID: ${!!localStorage.getItem('fl510_gist_id')}<br>`;
            
            showResult('basics-result', result, 'info');
        }

        async function testToken() {
            const token = document.getElementById('test-token').value.trim();
            if (!token) {
                showResult('token-result', 'è¯·è¾“å…¥Token', 'error');
                return;
            }

            showResult('token-result', 'æ­£åœ¨æµ‹è¯•Token...', 'info');

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    showResult('token-result', `âœ… Tokenæœ‰æ•ˆï¼ç”¨æˆ·: ${user.login}`, 'success');
                    
                    // ä¿å­˜Token
                    localStorage.setItem('github_sync_token', token);
                    if (window.configSync) {
                        window.configSync.githubToken = token;
                    }
                } else {
                    showResult('token-result', `âŒ Tokenæ— æ•ˆï¼ŒçŠ¶æ€ç : ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('token-result', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testSync() {
            showResult('sync-result', 'æ­£åœ¨æµ‹è¯•åŒæ­¥...', 'info');
            
            try {
                if (window.configSync && window.configSync.syncConfig) {
                    await window.configSync.syncConfig();
                    showResult('sync-result', 'âœ… åŒæ­¥æµ‹è¯•å®Œæˆ', 'success');
                } else {
                    showResult('sync-result', 'âŒ configSyncä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showResult('sync-result', `âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testLoad() {
            showResult('sync-result', 'æ­£åœ¨æµ‹è¯•åŠ è½½...', 'info');
            
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        showResult('sync-result', `âœ… åŠ è½½æˆåŠŸ: ${JSON.stringify(config)}`, 'success');
                    } else {
                        showResult('sync-result', 'âš ï¸ æ²¡æœ‰äº‘ç«¯é…ç½®', 'info');
                    }
                } else {
                    showResult('sync-result', 'âŒ configSyncä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showResult('sync-result', `âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function addTestUser() {
            try {
                // è·å–å½“å‰é…ç½®
                let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                if (!config.allowedUsers) config.allowedUsers = [];
                if (!config.adminUsers) config.adminUsers = [];

                // æ·»åŠ æµ‹è¯•ç”¨æˆ·
                const testUser = 'test-user-' + Date.now();
                config.allowedUsers.push(testUser);
                
                // ä¿å­˜é…ç½®
                localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                
                // æ›´æ–°å…¨å±€é…ç½®
                if (window.AUTH_CONFIG) {
                    window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
                }

                showResult('config-result', `âœ… æ·»åŠ æµ‹è¯•ç”¨æˆ·: ${testUser}`, 'success');
            } catch (error) {
                showResult('config-result', `âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                showResult('config-result', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
            } catch (error) {
                showResult('config-result', `âŒ æ˜¾ç¤ºé…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showDebug() {
            let debug = 'è°ƒè¯•ä¿¡æ¯ï¼š<br><pre>';
            
            debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
            debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
            debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
            
            // æ£€æŸ¥å„ä¸ªæ–¹æ³•
            if (window.configSync) {
                debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
                debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
                debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
                debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
            }
            
            debug += '</pre>';
            showResult('debug-result', debug, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkBasics();
            }, 1000);
        });
    </script>
</body>
</html>
