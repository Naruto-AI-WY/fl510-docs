<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>服务器配置管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .config-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .config-button:hover {
            background: #0056b3;
        }
        .config-button.danger {
            background: #dc3545;
        }
        .config-button.success {
            background: #28a745;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .token-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🖥️ 服务器配置管理</h1>
    
    <div class="config-section">
        <h2>1. 服务器同步状态</h2>
        <button class="config-button" onclick="checkServerStatus()">检查服务器状态</button>
        <div id="server-status"></div>
    </div>

    <div class="config-section">
        <h2>2. GitHub Token 设置</h2>
        <div class="config-info">
            <p><strong>说明：</strong>使用GitHub Gist作为服务器存储，确保配置在清除浏览器缓存后不会丢失。</p>
            <p><strong>优势：</strong></p>
            <ul>
                <li>✅ 配置永久保存在GitHub服务器上</li>
                <li>✅ 清除浏览器缓存不会丢失数据</li>
                <li>✅ 跨浏览器和设备同步</li>
                <li>✅ 数据安全，只有您能访问</li>
            </ul>
        </div>
        
        <div>
            <label>GitHub Personal Access Token:</label>
            <input type="password" id="github-token" class="token-input" placeholder="输入GitHub Personal Access Token">
            <button class="config-button" onclick="setGitHubToken()">设置Token</button>
            <button class="config-button" onclick="testGitHubToken()">测试Token</button>
        </div>
        <div id="token-status"></div>
    </div>

    <div class="config-section">
        <h2>3. 配置同步操作</h2>
        <button class="config-button" onclick="syncToServer()">同步到服务器</button>
        <button class="config-button" onclick="loadFromServer()">从服务器加载</button>
        <button class="config-button" onclick="forceSync()">强制同步</button>
        <div id="sync-status"></div>
    </div>

    <div class="config-section">
        <h2>4. 用户配置管理</h2>
        <div>
            <label>添加用户:</label>
            <input type="text" id="new-user" placeholder="输入GitHub用户名" style="width: 200px; padding: 5px; margin: 5px;">
            <button class="config-button" onclick="addUser()">添加用户</button>
        </div>
        <div>
            <button class="config-button" onclick="showCurrentConfig()">显示当前配置</button>
            <button class="config-button" onclick="showServerConfig()">显示服务器配置</button>
        </div>
        <div id="user-status"></div>
    </div>

    <div class="config-section">
        <h2>5. 数据备份与恢复</h2>
        <button class="config-button success" onclick="backupConfig()">备份配置</button>
        <button class="config-button" onclick="restoreConfig()">恢复配置</button>
        <button class="config-button danger" onclick="clearAllConfig()">清除所有配置</button>
        <div id="backup-status"></div>
    </div>

    <div class="config-section">
        <h2>6. 调试信息</h2>
        <button class="config-button" onclick="showDebugInfo()">显示调试信息</button>
        <div id="debug-info"></div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/config-sync.js"></script>

    <script>
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkServerStatus() {
            let status = '服务器状态检查：<br>';
            
            // 检查配置同步对象
            status += `配置同步对象: ${!!window.configSync ? '✅' : '❌'}<br>`;
            status += `初始化状态: ${window.configSync?.initialized ? '✅' : '❌'}<br>`;
            status += `GitHub Token: ${!!window.configSync?.githubToken ? '✅' : '❌'}<br>`;
            status += `Gist ID: ${!!window.configSync?.gistId ? '✅' : '❌'}<br>`;
            
            // 检查本地配置
            const localConfig = localStorage.getItem('fl510_docs_config');
            status += `本地配置: ${localConfig ? '✅' : '❌'}<br>`;
            
            // 检查服务器配置
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const serverConfig = await window.configSync.loadConfig();
                    status += `服务器配置: ${serverConfig ? '✅' : '❌'}<br>`;
                    if (serverConfig) {
                        status += `服务器用户数: ${serverConfig.allowedUsers?.length || 0}<br>`;
                    }
                } else {
                    status += `服务器配置: ❌ (配置同步不可用)<br>`;
                }
            } catch (error) {
                status += `服务器配置: ❌ (${error.message})<br>`;
            }
            
            showStatus('server-status', status, 'info');
        }

        function setGitHubToken() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                showStatus('token-status', '请输入GitHub Token', 'error');
                return;
            }
            
            // 保存Token
            localStorage.setItem('github_sync_token', token);
            if (window.configSync) {
                window.configSync.githubToken = token;
            }
            
            showStatus('token-status', 'GitHub Token已保存', 'success');
        }

        async function testGitHubToken() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                showStatus('token-status', '请先输入GitHub Token', 'error');
                return;
            }
            
            showStatus('token-status', '正在测试Token...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    showStatus('token-status', `✅ Token有效！用户: ${user.login}`, 'success');
                    
                    // 保存Token
                    localStorage.setItem('github_sync_token', token);
                    if (window.configSync) {
                        window.configSync.githubToken = token;
                    }
                } else {
                    showStatus('token-status', `❌ Token无效，状态码: ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('token-status', `❌ 网络错误: ${error.message}`, 'error');
            }
        }

        async function syncToServer() {
            showStatus('sync-status', '正在同步到服务器...', 'info');
            
            try {
                if (window.configSync && window.configSync.syncConfig) {
                    await window.configSync.syncConfig();
                    showStatus('sync-status', '✅ 配置已同步到服务器', 'success');
                } else {
                    showStatus('sync-status', '❌ 配置同步功能不可用', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `❌ 同步失败: ${error.message}`, 'error');
            }
        }

        async function loadFromServer() {
            showStatus('sync-status', '正在从服务器加载...', 'info');
            
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        // 应用配置到本地
                        localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                        if (window.AUTH_CONFIG) {
                            window.AUTH_CONFIG.allowedUsers = config.allowedUsers || [];
                            window.AUTH_CONFIG.adminUsers = config.adminUsers || [];
                        }
                        showStatus('sync-status', `✅ 已从服务器加载配置，用户数: ${config.allowedUsers?.length || 0}`, 'success');
                    } else {
                        showStatus('sync-status', '⚠️ 服务器没有配置数据', 'warning');
                    }
                } else {
                    showStatus('sync-status', '❌ 配置同步功能不可用', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `❌ 加载失败: ${error.message}`, 'error');
            }
        }

        async function forceSync() {
            showStatus('sync-status', '正在强制同步...', 'info');
            
            try {
                // 先加载服务器配置
                if (window.configSync && window.configSync.loadConfig) {
                    const serverConfig = await window.configSync.loadConfig();
                    if (serverConfig) {
                        // 合并服务器和本地配置
                        const localConfig = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                        const mergedConfig = {
                            allowedUsers: [...new Set([...(serverConfig.allowedUsers || []), ...(localConfig.allowedUsers || [])])],
                            adminUsers: [...new Set([...(serverConfig.adminUsers || []), ...(localConfig.adminUsers || [])])]
                        };
                        
                        // 保存合并后的配置
                        localStorage.setItem('fl510_docs_config', JSON.stringify(mergedConfig));
                        if (window.AUTH_CONFIG) {
                            window.AUTH_CONFIG.allowedUsers = mergedConfig.allowedUsers;
                            window.AUTH_CONFIG.adminUsers = mergedConfig.adminUsers;
                        }
                        
                        // 同步到服务器
                        await window.configSync.syncConfig();
                        showStatus('sync-status', `✅ 强制同步完成，用户数: ${mergedConfig.allowedUsers.length}`, 'success');
                    } else {
                        showStatus('sync-status', '⚠️ 服务器没有配置，仅同步本地配置', 'warning');
                        await window.configSync.syncConfig();
                    }
                } else {
                    showStatus('sync-status', '❌ 配置同步功能不可用', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `❌ 强制同步失败: ${error.message}`, 'error');
            }
        }

        function addUser() {
            const username = document.getElementById('new-user').value.trim();
            if (!username) {
                showStatus('user-status', '请输入用户名', 'error');
                return;
            }
            
            try {
                let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                if (!config.allowedUsers) config.allowedUsers = [];
                if (!config.adminUsers) config.adminUsers = [];
                
                if (!config.allowedUsers.includes(username)) {
                    config.allowedUsers.push(username);
                    localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                    
                    if (window.AUTH_CONFIG) {
                        window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
                    }
                    
                    showStatus('user-status', `✅ 用户 ${username} 已添加`, 'success');
                    document.getElementById('new-user').value = '';
                } else {
                    showStatus('user-status', `⚠️ 用户 ${username} 已存在`, 'warning');
                }
            } catch (error) {
                showStatus('user-status', `❌ 添加用户失败: ${error.message}`, 'error');
            }
        }

        function showCurrentConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                showStatus('user-status', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
            } catch (error) {
                showStatus('user-status', `❌ 显示配置失败: ${error.message}`, 'error');
            }
        }

        async function showServerConfig() {
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        showStatus('user-status', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
                    } else {
                        showStatus('user-status', '⚠️ 服务器没有配置数据', 'warning');
                    }
                } else {
                    showStatus('user-status', '❌ 配置同步功能不可用', 'error');
                }
            } catch (error) {
                showStatus('user-status', `❌ 加载服务器配置失败: ${error.message}`, 'error');
            }
        }

        function backupConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                const backup = {
                    timestamp: new Date().toISOString(),
                    config: config
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fl510-config-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('backup-status', '✅ 配置已备份到文件', 'success');
            } catch (error) {
                showStatus('backup-status', `❌ 备份失败: ${error.message}`, 'error');
            }
        }

        function restoreConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backup = JSON.parse(e.target.result);
                            if (backup.config) {
                                localStorage.setItem('fl510_docs_config', JSON.stringify(backup.config));
                                if (window.AUTH_CONFIG) {
                                    window.AUTH_CONFIG.allowedUsers = backup.config.allowedUsers || [];
                                    window.AUTH_CONFIG.adminUsers = backup.config.adminUsers || [];
                                }
                                showStatus('backup-status', '✅ 配置已恢复', 'success');
                            } else {
                                showStatus('backup-status', '❌ 备份文件格式错误', 'error');
                            }
                        } catch (error) {
                            showStatus('backup-status', `❌ 恢复失败: ${error.message}`, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllConfig() {
            if (confirm('确定要清除所有配置吗？此操作不可恢复！')) {
                localStorage.removeItem('fl510_docs_config');
                localStorage.removeItem('github_sync_token');
                localStorage.removeItem('fl510_gist_id');
                if (window.AUTH_CONFIG) {
                    window.AUTH_CONFIG.allowedUsers = [];
                    window.AUTH_CONFIG.adminUsers = [];
                }
                showStatus('backup-status', '✅ 所有配置已清除', 'success');
            }
        }

        function showDebugInfo() {
            let debug = '调试信息：<br><pre>';
            
            debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
            debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
            debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
            
            if (window.configSync) {
                debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
                debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
                debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
                debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
            }
            
            debug += '</pre>';
            showStatus('debug-info', debug, 'info');
        }

        // 页面加载时自动检查状态
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkServerStatus();
            }, 1000);
        });
    </script>
</body>
</html>
