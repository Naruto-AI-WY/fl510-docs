<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å™¨é…ç½®ç®¡ç†</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .config-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .config-button:hover {
            background: #0056b3;
        }
        .config-button.danger {
            background: #dc3545;
        }
        .config-button.success {
            background: #28a745;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .token-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ–¥ï¸ æœåŠ¡å™¨é…ç½®ç®¡ç†</h1>
    
    <div class="config-section">
        <h2>1. æœåŠ¡å™¨åŒæ­¥çŠ¶æ€</h2>
        <button class="config-button" onclick="checkServerStatus()">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€</button>
        <div id="server-status"></div>
    </div>

    <div class="config-section">
        <h2>2. GitHub Token è®¾ç½®</h2>
        <div class="config-info">
            <p><strong>è¯´æ˜ï¼š</strong>ä½¿ç”¨GitHub Gistä½œä¸ºæœåŠ¡å™¨å­˜å‚¨ï¼Œç¡®ä¿é…ç½®åœ¨æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åä¸ä¼šä¸¢å¤±ã€‚</p>
            <p><strong>ä¼˜åŠ¿ï¼š</strong></p>
            <ul>
                <li>âœ… é…ç½®æ°¸ä¹…ä¿å­˜åœ¨GitHubæœåŠ¡å™¨ä¸Š</li>
                <li>âœ… æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä¸ä¼šä¸¢å¤±æ•°æ®</li>
                <li>âœ… è·¨æµè§ˆå™¨å’Œè®¾å¤‡åŒæ­¥</li>
                <li>âœ… æ•°æ®å®‰å…¨ï¼Œåªæœ‰æ‚¨èƒ½è®¿é—®</li>
            </ul>
        </div>
        
        <div>
            <label>GitHub Personal Access Token:</label>
            <input type="password" id="github-token" class="token-input" placeholder="è¾“å…¥GitHub Personal Access Token">
            <button class="config-button" onclick="setGitHubToken()">è®¾ç½®Token</button>
            <button class="config-button" onclick="testGitHubToken()">æµ‹è¯•Token</button>
        </div>
        <div id="token-status"></div>
    </div>

    <div class="config-section">
        <h2>3. é…ç½®åŒæ­¥æ“ä½œ</h2>
        <button class="config-button" onclick="syncToServer()">åŒæ­¥åˆ°æœåŠ¡å™¨</button>
        <button class="config-button" onclick="loadFromServer()">ä»æœåŠ¡å™¨åŠ è½½</button>
        <button class="config-button" onclick="forceSync()">å¼ºåˆ¶åŒæ­¥</button>
        <div id="sync-status"></div>
    </div>

    <div class="config-section">
        <h2>4. ç”¨æˆ·é…ç½®ç®¡ç†</h2>
        <div>
            <label>æ·»åŠ ç”¨æˆ·:</label>
            <input type="text" id="new-user" placeholder="è¾“å…¥GitHubç”¨æˆ·å" style="width: 200px; padding: 5px; margin: 5px;">
            <button class="config-button" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
        </div>
        <div>
            <button class="config-button" onclick="showCurrentConfig()">æ˜¾ç¤ºå½“å‰é…ç½®</button>
            <button class="config-button" onclick="showServerConfig()">æ˜¾ç¤ºæœåŠ¡å™¨é…ç½®</button>
        </div>
        <div id="user-status"></div>
    </div>

    <div class="config-section">
        <h2>5. æ•°æ®å¤‡ä»½ä¸æ¢å¤</h2>
        <button class="config-button success" onclick="backupConfig()">å¤‡ä»½é…ç½®</button>
        <button class="config-button" onclick="restoreConfig()">æ¢å¤é…ç½®</button>
        <button class="config-button danger" onclick="clearAllConfig()">æ¸…é™¤æ‰€æœ‰é…ç½®</button>
        <div id="backup-status"></div>
    </div>

    <div class="config-section">
        <h2>6. è°ƒè¯•ä¿¡æ¯</h2>
        <button class="config-button" onclick="showDebugInfo()">æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</button>
        <div id="debug-info"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/config-sync.js"></script>

    <script>
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        async function checkServerStatus() {
            let status = 'æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥ï¼š<br>';
            
            // æ£€æŸ¥é…ç½®åŒæ­¥å¯¹è±¡
            status += `é…ç½®åŒæ­¥å¯¹è±¡: ${!!window.configSync ? 'âœ…' : 'âŒ'}<br>`;
            status += `åˆå§‹åŒ–çŠ¶æ€: ${window.configSync?.initialized ? 'âœ…' : 'âŒ'}<br>`;
            status += `GitHub Token: ${!!window.configSync?.githubToken ? 'âœ…' : 'âŒ'}<br>`;
            status += `Gist ID: ${!!window.configSync?.gistId ? 'âœ…' : 'âŒ'}<br>`;
            
            // æ£€æŸ¥æœ¬åœ°é…ç½®
            const localConfig = localStorage.getItem('fl510_docs_config');
            status += `æœ¬åœ°é…ç½®: ${localConfig ? 'âœ…' : 'âŒ'}<br>`;
            
            // æ£€æŸ¥æœåŠ¡å™¨é…ç½®
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const serverConfig = await window.configSync.loadConfig();
                    status += `æœåŠ¡å™¨é…ç½®: ${serverConfig ? 'âœ…' : 'âŒ'}<br>`;
                    if (serverConfig) {
                        status += `æœåŠ¡å™¨ç”¨æˆ·æ•°: ${serverConfig.allowedUsers?.length || 0}<br>`;
                    }
                } else {
                    status += `æœåŠ¡å™¨é…ç½®: âŒ (é…ç½®åŒæ­¥ä¸å¯ç”¨)<br>`;
                }
            } catch (error) {
                status += `æœåŠ¡å™¨é…ç½®: âŒ (${error.message})<br>`;
            }
            
            showStatus('server-status', status, 'info');
        }

        function setGitHubToken() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                showStatus('token-status', 'è¯·è¾“å…¥GitHub Token', 'error');
                return;
            }
            
            // ä¿å­˜Token
            localStorage.setItem('github_sync_token', token);
            if (window.configSync) {
                window.configSync.githubToken = token;
            }
            
            showStatus('token-status', 'GitHub Tokenå·²ä¿å­˜', 'success');
        }

        async function testGitHubToken() {
            const token = document.getElementById('github-token').value.trim();
            if (!token) {
                showStatus('token-status', 'è¯·å…ˆè¾“å…¥GitHub Token', 'error');
                return;
            }
            
            showStatus('token-status', 'æ­£åœ¨æµ‹è¯•Token...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    showStatus('token-status', `âœ… Tokenæœ‰æ•ˆï¼ç”¨æˆ·: ${user.login}`, 'success');
                    
                    // ä¿å­˜Token
                    localStorage.setItem('github_sync_token', token);
                    if (window.configSync) {
                        window.configSync.githubToken = token;
                    }
                } else {
                    showStatus('token-status', `âŒ Tokenæ— æ•ˆï¼ŒçŠ¶æ€ç : ${response.status}`, 'error');
                }
            } catch (error) {
                showStatus('token-status', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function syncToServer() {
            showStatus('sync-status', 'æ­£åœ¨åŒæ­¥åˆ°æœåŠ¡å™¨...', 'info');
            
            try {
                if (window.configSync && window.configSync.syncConfig) {
                    await window.configSync.syncConfig();
                    showStatus('sync-status', 'âœ… é…ç½®å·²åŒæ­¥åˆ°æœåŠ¡å™¨', 'success');
                } else {
                    showStatus('sync-status', 'âŒ é…ç½®åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `âŒ åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function loadFromServer() {
            showStatus('sync-status', 'æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½...', 'info');
            
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        // åº”ç”¨é…ç½®åˆ°æœ¬åœ°
                        localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                        if (window.AUTH_CONFIG) {
                            window.AUTH_CONFIG.allowedUsers = config.allowedUsers || [];
                            window.AUTH_CONFIG.adminUsers = config.adminUsers || [];
                        }
                        showStatus('sync-status', `âœ… å·²ä»æœåŠ¡å™¨åŠ è½½é…ç½®ï¼Œç”¨æˆ·æ•°: ${config.allowedUsers?.length || 0}`, 'success');
                    } else {
                        showStatus('sync-status', 'âš ï¸ æœåŠ¡å™¨æ²¡æœ‰é…ç½®æ•°æ®', 'warning');
                    }
                } else {
                    showStatus('sync-status', 'âŒ é…ç½®åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function forceSync() {
            showStatus('sync-status', 'æ­£åœ¨å¼ºåˆ¶åŒæ­¥...', 'info');
            
            try {
                // å…ˆåŠ è½½æœåŠ¡å™¨é…ç½®
                if (window.configSync && window.configSync.loadConfig) {
                    const serverConfig = await window.configSync.loadConfig();
                    if (serverConfig) {
                        // åˆå¹¶æœåŠ¡å™¨å’Œæœ¬åœ°é…ç½®
                        const localConfig = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                        const mergedConfig = {
                            allowedUsers: [...new Set([...(serverConfig.allowedUsers || []), ...(localConfig.allowedUsers || [])])],
                            adminUsers: [...new Set([...(serverConfig.adminUsers || []), ...(localConfig.adminUsers || [])])]
                        };
                        
                        // ä¿å­˜åˆå¹¶åçš„é…ç½®
                        localStorage.setItem('fl510_docs_config', JSON.stringify(mergedConfig));
                        if (window.AUTH_CONFIG) {
                            window.AUTH_CONFIG.allowedUsers = mergedConfig.allowedUsers;
                            window.AUTH_CONFIG.adminUsers = mergedConfig.adminUsers;
                        }
                        
                        // åŒæ­¥åˆ°æœåŠ¡å™¨
                        await window.configSync.syncConfig();
                        showStatus('sync-status', `âœ… å¼ºåˆ¶åŒæ­¥å®Œæˆï¼Œç”¨æˆ·æ•°: ${mergedConfig.allowedUsers.length}`, 'success');
                    } else {
                        showStatus('sync-status', 'âš ï¸ æœåŠ¡å™¨æ²¡æœ‰é…ç½®ï¼Œä»…åŒæ­¥æœ¬åœ°é…ç½®', 'warning');
                        await window.configSync.syncConfig();
                    }
                } else {
                    showStatus('sync-status', 'âŒ é…ç½®åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showStatus('sync-status', `âŒ å¼ºåˆ¶åŒæ­¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function addUser() {
            const username = document.getElementById('new-user').value.trim();
            if (!username) {
                showStatus('user-status', 'è¯·è¾“å…¥ç”¨æˆ·å', 'error');
                return;
            }
            
            try {
                let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                if (!config.allowedUsers) config.allowedUsers = [];
                if (!config.adminUsers) config.adminUsers = [];
                
                if (!config.allowedUsers.includes(username)) {
                    config.allowedUsers.push(username);
                    localStorage.setItem('fl510_docs_config', JSON.stringify(config));
                    
                    if (window.AUTH_CONFIG) {
                        window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
                    }
                    
                    showStatus('user-status', `âœ… ç”¨æˆ· ${username} å·²æ·»åŠ `, 'success');
                    document.getElementById('new-user').value = '';
                } else {
                    showStatus('user-status', `âš ï¸ ç”¨æˆ· ${username} å·²å­˜åœ¨`, 'warning');
                }
            } catch (error) {
                showStatus('user-status', `âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showCurrentConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                showStatus('user-status', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
            } catch (error) {
                showStatus('user-status', `âŒ æ˜¾ç¤ºé…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function showServerConfig() {
            try {
                if (window.configSync && window.configSync.loadConfig) {
                    const config = await window.configSync.loadConfig();
                    if (config) {
                        showStatus('user-status', `<pre>${JSON.stringify(config, null, 2)}</pre>`, 'info');
                    } else {
                        showStatus('user-status', 'âš ï¸ æœåŠ¡å™¨æ²¡æœ‰é…ç½®æ•°æ®', 'warning');
                    }
                } else {
                    showStatus('user-status', 'âŒ é…ç½®åŒæ­¥åŠŸèƒ½ä¸å¯ç”¨', 'error');
                }
            } catch (error) {
                showStatus('user-status', `âŒ åŠ è½½æœåŠ¡å™¨é…ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function backupConfig() {
            try {
                const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
                const backup = {
                    timestamp: new Date().toISOString(),
                    config: config
                };
                
                const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fl510-config-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showStatus('backup-status', 'âœ… é…ç½®å·²å¤‡ä»½åˆ°æ–‡ä»¶', 'success');
            } catch (error) {
                showStatus('backup-status', `âŒ å¤‡ä»½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function restoreConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backup = JSON.parse(e.target.result);
                            if (backup.config) {
                                localStorage.setItem('fl510_docs_config', JSON.stringify(backup.config));
                                if (window.AUTH_CONFIG) {
                                    window.AUTH_CONFIG.allowedUsers = backup.config.allowedUsers || [];
                                    window.AUTH_CONFIG.adminUsers = backup.config.adminUsers || [];
                                }
                                showStatus('backup-status', 'âœ… é…ç½®å·²æ¢å¤', 'success');
                            } else {
                                showStatus('backup-status', 'âŒ å¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯', 'error');
                            }
                        } catch (error) {
                            showStatus('backup-status', `âŒ æ¢å¤å¤±è´¥: ${error.message}`, 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function clearAllConfig() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('fl510_docs_config');
                localStorage.removeItem('github_sync_token');
                localStorage.removeItem('fl510_gist_id');
                if (window.AUTH_CONFIG) {
                    window.AUTH_CONFIG.allowedUsers = [];
                    window.AUTH_CONFIG.adminUsers = [];
                }
                showStatus('backup-status', 'âœ… æ‰€æœ‰é…ç½®å·²æ¸…é™¤', 'success');
            }
        }

        function showDebugInfo() {
            let debug = 'è°ƒè¯•ä¿¡æ¯ï¼š<br><pre>';
            
            debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
            debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
            debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
            
            if (window.configSync) {
                debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
                debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
                debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
                debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
            }
            
            debug += '</pre>';
            showStatus('debug-info', debug, 'info');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkServerStatus();
            }, 1000);
        });
    </script>
</body>
</html>
