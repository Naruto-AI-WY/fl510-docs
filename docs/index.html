<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FL‑510 软件分层动效图（v5.3R4 离线：RS485 子项逐项缩进）</title>
<style>
:root{
  --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --text:#111827; --border:#e5e7eb;
  --primary:#2563eb; --primary-fore:#ffffff; --radius:16px;
  --shadow: 0 8px 24px rgba(17,24,39,.06), 0 2px 8px rgba(17,24,39,.04);
  --mark-bg:#fde68a; --mark-fg:#111827;
  --error-bg:#fee2e2; --error-fg:#991b1b;
  --rail-bg:#fafafa;
}
[data-theme="dark"]{
  --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --border:#243045;
  --primary:#60a5fa; --primary-fore:#0b1020; --shadow: 0 10px 28px rgba(2,6,23,.35), 0 2px 10px rgba(2,6,23,.3);
  --mark-bg:#4b5563; --mark-fg:#fff;
  --error-bg:#3f1d1d; --error-fg:#fecaca;
  --rail-bg:#0b1222;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:var(--bg)}
.container{max-width:1180px;margin:0 auto;padding:24px}
.errorbar{display:none;margin-bottom:12px;padding:10px 12px;border-radius:12px;background:var(--error-bg);color:var(--error-fg);border:1px solid var(--border)}
.topbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.titlebox{border:1px solid var(--border);border-radius:calc(var(--radius)+4px);background:var(--card);padding:10px 14px;box-shadow:var(--shadow)}
.title{font-weight:700;font-size:18px;line-height:1.2}
.subtitle{font-size:12px;color:var(--muted);margin-top:2px}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer;transition:.2s box-shadow,.2s transform;color:var(--text)}
.btn:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:var(--primary-fore)}
.btn.secondary{background:#f3f4f6;color:#111827}
[data-theme="dark"] .btn.secondary{background:#0b1222;color:var(--text)}
.icon{width:16px;height:16px;display:inline-block}
.input{position:relative;display:inline-flex;align-items:center}
.input input{width:260px;padding:9px 12px 9px 32px;border-radius:12px;border:1px solid var(--border);background:var(--card);outline:none;color:var(--text)}
.input svg{position:absolute;left:10px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;position:relative}
@media (max-width:980px){.grid{grid-template-columns:1fr} .input input{width:100%}}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.layer{border-radius:var(--radius);border:1px dashed var(--border);background:linear-gradient(180deg,#f9fafb,#f3f4f6);padding:14px;box-shadow:var(--shadow)}
[data-theme="dark"] .layer{background:linear-gradient(180deg,#0f172a,#0b1222)}
.layer-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.layer-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.layer-sub{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--primary);color:var(--primary-fore);font-weight:700;font-size:12px;line-height:1}
.count{margin-left:8px}
.toggle{cursor:pointer;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#f9fafb;color:#111827}
[data-theme="dark"] .toggle{background:#0b1222;color:var(--text)}
.layer-body{overflow:hidden;transition:max-height .45s ease}
.pill{font-size:12px;color:#374151;background:#f9fafb;border:1px solid var(--border);padding:6px 10px;border-radius:999px;display:inline-block}
[data-theme="dark"] .pill{background:#0b1222;color:var(--text)}
.cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
@media (max-width:980px){.cards{grid-template-columns:1fr}}
.card{border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--card)}
.card h4{margin:0 0 6px 0;font-size:13px}
.meta{font-size:12px;color:var(--muted);margin-top:4px}
ul{margin:6px 0 0 16px;padding:0}
li{margin:4px 0;font-size:13px}
.rail{position:sticky;top:12px}
.rail h3{margin:0 0 8px 0;font-size:14px}
.muted{color:var(--muted)}
.empty{font-size:13px;color:var(--muted);padding:8px}
.tint-ui{background:linear-gradient(180deg,#f5f3ff,#f2efff)}
.tint-services{background:linear-gradient(180deg,#fff7ed,#fff3da)}
.tint-functional{background:linear-gradient(180deg,#ecfeff,#e6fbff)}
.tint-drivers{background:linear-gradient(180deg,#f8fafc,#eef2f7)}
[data-theme="dark"] .tint-ui{background:linear-gradient(180deg,#13122a,#110f22)}
[data-theme="dark"] .tint-services{background:linear-gradient(180deg,#1f172a,#171222)}
[data-theme="dark"] .tint-functional{background:linear-gradient(180deg,#0f1f2a,#0b1822)}
[data-theme="dark"] .tint-drivers{background:linear-gradient(180deg,#0f172a,#0b1222)}
mark{background:var(--mark-bg);color:var(--mark-fg);padding:0 .12em;border-radius:4px}
/* 播放强调 */
.pulse{animation:pulse .9s ease-out 1}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,99,235,.35)}100%{box-shadow:0 0 0 18px rgba(37,99,235,0)}}
/* Tree styles */
.tree{list-style:none;margin:0;padding:0;display:grid;gap:6px}
.tree .row{display:flex;align-items:flex-start;gap:8px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--rail-bg)}
.tree .row .label{display:flex;flex-direction:column}
.tree .row .name{font-weight:600;font-size:13px}
.tree .row .meta{font-size:12px;color:var(--muted);margin-top:2px}
.tree .twisty{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;user-select:none;transition:transform .2s}
.tree .twisty::after{content:"›";font-size:12px;line-height:1;transform:rotate(0deg);display:inline-block}
.tree .node.open>.row .twisty::after{transform:rotate(90deg)}
.tree .children{margin-left:22px;margin-top:6px;padding-left:10px;border-left:1px dashed var(--border);display:none}
.tree .node.open>.children{display:block}
.tree .leaf .dot{width:6px;height:6px;border-radius:999px;background:var(--primary);margin-top:6px}
@media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
@media print{ @page{size:A4 landscape;margin:10mm} .btn,.controls,.rail{display:none!important} .layer{break-inside:avoid;page-break-inside:avoid} }
</style>
</head>
<body>
<div class="container">
  <div id="err" class="errorbar"></div>
  <div class="topbar">
    <div class="titlebox">
      <div class="title">FL‑510 软件分层（v1.0R2）</div>
      <div class="subtitle">顺序标注 · 搜索高亮 · 深色主题 · 串行动画播放 · 通信与协议层级展示（含 RS485 逐项）</div>
    </div>
    <div class="controls">
      <span id="playCount" class="muted">尚未播放</span>
      <span class="muted">·</span>
      <div class="input">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input id="searchInput" placeholder="搜索：如 'pH' / '加液' / 'RS485' …" />
      </div>
      <button id="playBtn" class="btn primary"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 播放</button>
      <button id="toggleAllBtn" class="btn secondary"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h16v4H4z"/></svg> 全部折叠</button>
      <button id="themeBtn" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> 主题：浅色</button>
      <button id="printBtn" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 9V2h12v7m-2 5h2a2 2 0 0 1 2 2v4H4v-4a2 2 0 0 1 2-2h2"/></svg> 打印 / 导出 PDF</button>
    </div>
  </div>

  <div class="grid" id="capture-area">
    <div id="layersCol" class="panel"></div>
    <aside class="panel rail">
      <h3>通信与协议</h3>
      <ul id="commsTree" class="tree"></ul>
    </aside>
  </div>
</div>

<script>
(function(){
  const bar = document.getElementById('err');
  function show(msg){ bar.style.display='block'; bar.innerHTML = '<strong>脚本提示：</strong> ' + msg; }
  window.addEventListener('error', e => { show(e.message); });
  window.addEventListener('unhandledrejection', e => { show('Promise 错误：' + (e.reason && e.reason.message || e.reason)); });
})();
</script>
<script>
// 顺序：① 上位机与显示层 → ② 服务层 → ③ 功能驱动层 → ④ 底层驱动层
const DATA = {
  layers: [
    { id:"ui", name:"上位机与显示层", subtitle:"人机界面、任务下发与设备测试", tint:"tint-ui", kind:"items",
      items:[
        { name:"上位机服务", items:["配液任务下发","心跳回复","打印任务下发","配液状态恢复"] },
        { name:"显示屏服务", items:["设备当前状态","开关量测试","大体积测试","小体积测试","打印测试","灌装下发测试"] }
      ]
    },
    { id:"services", name:"服务层", subtitle:"面向流程的业务编排", tint:"tint-services", kind:"buckets",
      buckets:[
        { title:"配液服务", items:["固体试剂添加","大体积加液","小体积加液","pH 测定/酸碱添加","灌装下发通讯","电极清洗","配液桶清洗","上传配液数据"] },
        { title:"加液服务程序", items:["大体积加液服务：加液/校准/填充","2 路酸碱服务：小体积加液/校准/清洗/填充/通路切换","8 路小体积服务：加液/校准/填充"] },
        { title:"机械臂/末端服务", items:["大肯机械臂（左）：固体添加/搅拌/夹爪清洗/初始化","大肯机械臂（右）：电极校准/pH 测定/电极清洗/初始化","清洗臂：配液桶清洗/吹干/初始化"] },
        { title:"清洗服务（通用）", items:["pH 电极清洗","配液桶清洗","夹爪清洗","大体积回路清洗","小体积回路清洗","旋切阀清洗"] },
        { title:"标定服务", items:["小体积标定","大体积标定","pH 电极校准"] }
      ]
    },
    { id:"functional", name:"功能驱动层", subtitle:"把原子驱动组合为可复用功能块", tint:"tint-functional", kind:"groups",
      groups:[
        { name:"酸碱加液（2 路 10 通道）", items:["注射泵驱动","加液臂驱动"], link:"services/programs/acid-alkali-2ch-program.md" },
        { name:"小体积加液（8 路）", items:["注射泵驱动","加液臂驱动"], link:"services/programs/small-dosing-8ch-program.md" },
        { name:"大体积加液（4 路）", items:["大体积加液驱动","开关量驱动","管路检测（液位）"], link:"services/programs/large-dosing-program.md" },
        { name:"清洗臂", items:["清洗臂驱动","开关量驱动"], link:"services/cleaning/cleaning-arm.md" },
        { name:"大肯机械臂（左/右）", items:["大肯机械臂驱动","夹爪驱动","pH 电极驱动"], link:"services/arms/daken-left.md" },
        { name:"试剂检测", items:["RS485"], link:"services/calibration/large.md" },
        { name:"管路检测（液位）", items:["直驱"], link:"services/calibration/small.md" }
      ]
    },
    { id:"drivers", name:"底层驱动层", subtitle:"设备与执行器的直接驱动", tint:"tint-drivers", kind:"items",
      items:[
        { name:"注射泵驱动", meta:"RS485", link:"services/dispense/small-dosing.md" },
        { name:"加液臂驱动", meta:"Modbus Slave", link:"services/dispense/large-dosing.md" },
        { name:"pH 电极驱动", meta:"RS485", link:"services/calibration/ph-electrode.md" },
        { name:"多路旋切阀驱动", meta:"RS485", link:"services/cleaning/rotary-valve.md" },
        { name:"夹爪驱动", meta:"Modbus Slave", link:"services/cleaning/gripper.md" },
        { name:"大肯机械臂驱动", meta:"Modbus Slave", link:"services/arms/高精度回零方法：挡片中心定位法详解.md" },
        { name:"大体积加液驱动", meta:"直驱", link:"services/dispense/large-dosing.md" },
        { name:"开关量驱动", meta:"直驱（泵/阀/加热/超声/排风）", link:"services/screen/dio-test.md" }
      ]
    }
  ],
  commsTree:[
    { name:"主机通讯", meta:"TCP/IP", children:[
      { name:"JSON 协议", meta:"基于 TCP/IP；用于主机通讯 / 试剂检测" }
    ]},
    { name:"从机通讯", meta:"RS485（现场总线）", children:[
      { name:"Modbus RTU（从机）", meta:"", children:[
        { name:"加液臂驱动" }, { name:"夹爪驱动" }, { name:"大肯机械臂驱动" }
      ]},
      { name:"自由协议", meta:"", children:[
        { name:"注射泵驱动" }, { name:"pH 电极驱动" }, { name:"多路旋切阀驱动" }
      ]}
    ] },
    { name:"显示屏通讯", meta:"大彩通讯（预留）", children:[] }
  ]
};
</script>
<script>
const layersCol = document.getElementById('layersCol');
const commsTree = document.getElementById('commsTree');
const searchInput = document.getElementById('searchInput');
const playBtn = document.getElementById('playBtn');
const toggleAllBtn = document.getElementById('toggleAllBtn');
const playCount = document.getElementById('playCount');
const themeBtn = document.getElementById('themeBtn');
const printBtn = document.getElementById('printBtn');

let expandedAll = true, playTimes = 0, currentQuery = '';

// 底→上播放顺序
const PLAY_ORDER = ['drivers','functional','services','ui'];
const STEP_MS = 650; // 每层间隔

const circled = n => ({1:'①',2:'②',3:'③',4:'④'}[n] || String(n));

function h(tag, attrs={}, ...children){
  const el = document.createElement(tag);
  for(const k in attrs){
    if(k === 'class') el.className = attrs[k];
    else if(k === 'style') Object.assign(el.style, attrs[k]);
    else if(k.startsWith('on') && typeof attrs[k]==='function') el.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
    else if(k === 'dataset'){ for(const dk in attrs[k]) el.dataset[dk] = attrs[k][dk]; }
    else el.setAttribute(k, attrs[k]);
  }
  children.flat().forEach(c=>{
    if(c===null||c===undefined) return;
    if(typeof c === 'string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  });
  return el;
}
const keyify = s => (s||'').toString().trim().toLowerCase();
const toSearchText = s => keyify(s);

function escapeHtml(str){
  return (str+'').replace(/[&<>'"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[s]));
}
function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function highlightText(text, q){
  if(!q) return escapeHtml(text);
  const re = new RegExp('(' + escapeRegExp(q) + ')', 'ig');
  return escapeHtml(text).replace(re, '<mark>$1</mark>');
}

function buildItemCard(layerId, title, meta=null, list=null, link=null){
  const card = h('div', {class:'card', dataset:{layer:layerId, rawTitle:title, rawMeta:meta||'', rawList:JSON.stringify(list||[])}});
  
  // 如果有链接，添加点击事件
  if(link){
    card.style.cursor = 'pointer';
    card.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('点击链接:', link);
      // 确保链接是相对路径
      const fullLink = link.startsWith('http') ? link : './' + link;
      window.open(fullLink, '_blank');
    });
  }
  
  const h4 = h('h4', {}); h4.innerHTML = highlightText(title, currentQuery);
  card.appendChild(h4);
  if(meta){ const m = h('div', {class:'meta'}); m.innerHTML = highlightText(meta, currentQuery); card.appendChild(m); }
  if(Array.isArray(list) && list.length){
    const ul = h('ul');
    list.forEach(x => { const li = h('li'); li.innerHTML = highlightText(x, currentQuery); ul.appendChild(li); });
    card.appendChild(ul);
  }
  card.dataset.search = toSearchText([title, meta, ...(list||[])].join(' '));
  return card;
}

function buildLayer(layer, rank){
  const layerEl = document.createElement('section');
  layerEl.className = 'layer ' + layer.tint;
  layerEl.dataset.id = layer.id;
  const countSpan = h('span', {class:'pill count', style:{display:'none'}}, '');
  const head = h('div', {class:'layer-head'},
    h('div', {},
      h('div', {class:'layer-title'},
        h('span', {class:'badge'}, circled(rank+1)),
        layer.name,
        countSpan
      ),
      h('div', {class:'layer-sub'}, layer.subtitle)
    ),
    h('button', {class:'toggle', onclick:() => toggleOne(layerEl)}, expandedAll ? '折叠' : '展开')
  );
  const body = h('div', {class:'layer-body'});
  const cards = h('div', {class:'cards'});
  if(layer.kind === 'items'){
    (layer.items||[]).forEach(it => cards.appendChild(buildItemCard(layer.id, it.name||it.meta, it.meta||null, it.items||null, it.link||null)));
  }else if(layer.kind === 'groups'){
    (layer.groups||[]).forEach(g => cards.appendChild(buildItemCard(layer.id, g.name, null, g.items||[], g.link||null)));
  }else if(layer.kind === 'buckets'){
    (layer.buckets||[]).forEach(b => cards.appendChild(buildItemCard(layer.id, b.title, null, b.items||[], b.link||null)));
  }
  body.appendChild(cards);
  requestAnimationFrame(()=>{ body.style.maxHeight = expandedAll ? (body.scrollHeight+'px') : '0px'; });
  layerEl.appendChild(head); layerEl.appendChild(body);
  return layerEl;
}

function renderLayers(){
  layersCol.innerHTML = '';
  DATA.layers.forEach((layer, idx) => layersCol.appendChild(buildLayer(layer, idx)));
}

// 递归构建树节点
function buildTreeNode(node){
  const li = h('li', {class:'node open', dataset:{search: toSearchText(node.name + ' ' + (node.meta||'')), rawName: node.name, rawMeta: node.meta||''}});
  const row = h('div', {class:'row'});
  const twist = h('button', {class:'twisty', onclick: (e)=>{ e.stopPropagation(); li.classList.toggle('open'); }});
  const label = h('div', {class:'label'});
  const name = h('div', {class:'name'}); name.innerHTML = highlightText(node.name, currentQuery);
  const meta = h('div', {class:'meta'}); meta.innerHTML = highlightText(node.meta||'', currentQuery);
  label.appendChild(name); if(node.meta) label.appendChild(meta);
  row.appendChild(twist); row.appendChild(label);
  li.appendChild(row);
  if(node.children && node.children.length){
    const ul = h('ul', {class:'children'});
    node.children.forEach(ch => {
      if(ch.children && ch.children.length){
        ul.appendChild(buildTreeNode(ch));
      }else{
        ul.appendChild(buildTreeLeaf(ch));
      }
    });
    li.appendChild(ul);
  }
  return li;
}
function buildTreeLeaf(leaf){
  const li = h('li', {class:'leaf', dataset:{search: toSearchText(leaf.name + ' ' + (leaf.meta||'')), rawName: leaf.name, rawMeta: leaf.meta||''}});
  const row = h('div', {class:'row'});
  const dot = h('div', {class:'dot'});
  const label = h('div', {class:'label'});
  const name = h('div', {class:'name'}); name.innerHTML = highlightText(leaf.name, currentQuery);
  const meta = h('div', {class:'meta'}); meta.innerHTML = highlightText(leaf.meta||'', currentQuery);
  label.appendChild(name); if(leaf.meta) label.appendChild(meta);
  row.appendChild(dot); row.appendChild(label);
  li.appendChild(row);
  return li;
}
function renderComms(){
  commsTree.innerHTML = '';
  DATA.commsTree.forEach(n => commsTree.appendChild(buildTreeNode(n)));
}

function getLayerEl(id){ return document.querySelector('.layer[data-id="'+id+'"]'); }
function collapseLayer(id){
  const el = getLayerEl(id); if(!el) return;
  const body = el.querySelector('.layer-body'); const btn = el.querySelector('.toggle');
  body.style.maxHeight = '0px'; btn.textContent = '展开';
}
function expandLayer(id){
  const el = getLayerEl(id); if(!el) return;
  const body = el.querySelector('.layer-body'); const btn = el.querySelector('.toggle');
  body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = '折叠';
  el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
  const r = el.getBoundingClientRect();
  if(r.top < 80 || r.bottom > window.innerHeight){
    window.scrollTo({ top: window.scrollY + r.top - 70, behavior: 'smooth' });
  }
}

function toggleOne(layerEl){
  const body = layerEl.querySelector('.layer-body');
  const btn = layerEl.querySelector('.toggle');
  const isOpen = parseInt(body.style.maxHeight||'0') > 0;
  if(isOpen){ body.style.maxHeight = '0px'; btn.textContent = '展开'; }
  else { body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = '折叠'; }
}

function setAll(expand){
  expandedAll = expand;
  toggleAllBtn.innerHTML = expand
    ? '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h16v4H4z"/></svg> 全部折叠'
    : '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7h16M4 12h16M4 17h16"/></svg> 全部展开';
  DATA.layers.forEach(l=> expand ? expandLayer(l.id) : collapseLayer(l.id));
}

function updateCountsAndAutoExpand(q){
  const hasQ = !!q;
  document.querySelectorAll('.layer').forEach(layerEl=>{
    const cards = layerEl.querySelectorAll('.cards .card');
    let visibleCount = 0;
    cards.forEach(card=>{ if(card.style.display !== 'none') visibleCount++; });
    const pill = layerEl.querySelector('.count');
    if(hasQ){ pill.style.display = ''; pill.textContent = '· ' + visibleCount; }
    else { pill.style.display = 'none'; pill.textContent = ''; }
    const body = layerEl.querySelector('.layer-body');
    const btn = layerEl.querySelector('.toggle');
    if(hasQ){
      if(visibleCount>0){ body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = '折叠'; }
      else { body.style.maxHeight = '0px'; btn.textContent = '展开'; }
    }
  });
}

function search(q){
  currentQuery = (q||'').trim();
  const key = toSearchText(currentQuery);
  // 层内容卡片过滤
  document.querySelectorAll('.cards .card').forEach(card=>{
    const ok = card.dataset.search.includes(key);
    card.style.display = ok ? '' : 'none';
    const title = card.querySelector('h4');
    if(title){ title.innerHTML = highlightText(card.dataset.rawTitle, currentQuery); }
    const metaEl = card.querySelector('.meta');
    if(metaEl){ metaEl.innerHTML = highlightText(card.dataset.rawMeta, currentQuery); }
    const ul = card.querySelector('ul');
    if(ul){
      const raws = JSON.parse(card.dataset.rawList||'[]');
      ul.innerHTML = '';
      raws.forEach(x=>{ const li = document.createElement('li'); li.innerHTML = highlightText(x, currentQuery); ul.appendChild(li); });
    }
  });
  updateCountsAndAutoExpand(currentQuery);

  // 通信树过滤（递归：隐藏所有不匹配的叶子，显示其祖先节点，并在搜索时自动全部展开）
  const leaves = Array.from(commsTree.querySelectorAll('.leaf'));
  let any = false;
  leaves.forEach(leaf=>{
    const ok = (leaf.dataset.search||'').includes(key);
    leaf.style.display = ok || !key ? '' : 'none';
    const nameEl = leaf.querySelector('.name');
    const metaEl = leaf.querySelector('.meta');
    if(nameEl){ nameEl.innerHTML = highlightText(leaf.dataset.rawName||'', currentQuery); }
    if(metaEl){ metaEl.innerHTML = highlightText(leaf.dataset.rawMeta||'', currentQuery); }
    if(ok) any = true;
  });
  const allNodes = Array.from(commsTree.querySelectorAll('.node'));
  allNodes.forEach(n=>{
    const nodeMatch = (n.dataset.search||'').includes(key);
    // 子孙是否有可见叶子
    const hasVisibleLeaf = n.querySelector('.leaf:not([style*="display: none"])') !== null;
    const visible = key ? (nodeMatch || hasVisibleLeaf) : true;
    n.style.display = visible ? '' : 'none';
    const nameEl = n.querySelector(':scope > .row .name');
    const metaEl = n.querySelector(':scope > .row .meta');
    if(nameEl){ nameEl.innerHTML = highlightText(n.dataset.rawName||'', currentQuery); }
    if(metaEl){ metaEl.innerHTML = highlightText(n.dataset.rawMeta||'', currentQuery); }
    if(key){
      n.classList.add('open'); // 搜索时统一展开，便于查看
    }else{
      n.classList.add('open');
    }
  });

  // 定位第一个可见命中
  if(currentQuery){
    const first = document.querySelector('.cards .card:not([style*="display: none"])') || commsTree.querySelector('.leaf:not([style*="display: none"])');
    if(first){
      const r = first.getBoundingClientRect();
      if(r.top < 0 || r.bottom > window.innerHeight){
        window.scrollTo({ top: window.scrollY + r.top - 80, behavior: 'smooth' });
      }
    }
  }
}

// 播放：先折叠全部，再按 ④→③→②→① 逐层展开
function play(){
  playTimes += 1; playCount.textContent = '第 ' + playTimes + ' 次播放';
  DATA.layers.forEach(l=> collapseLayer(l.id));
  let t = 0; PLAY_ORDER.forEach(id=>{ setTimeout(()=> expandLayer(id), t); t += STEP_MS; });
}

function toggleTheme(){
  const html = document.documentElement;
  const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  themeBtn.innerHTML = (next === 'dark')
    ? '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> 主题：深色'
    : '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> 主题：浅色';
}

// events
playBtn.addEventListener('click', play);
toggleAllBtn.addEventListener('click', ()=> setAll(!expandedAll));
searchInput.addEventListener('input', e=> search(e.target.value));
themeBtn.addEventListener('click', toggleTheme);
printBtn.addEventListener('click', ()=> window.print());

// init
function render(){
  renderLayers();
  renderComms();
}
render();
setTimeout(()=> setAll(true), 0);
</script>

<script>
// 自动为"服务"条目加链接（点击跳转到对应 Markdown 页面）
const LINK_MAP = {
  "配液任务下发": "services/host/dispense-task/",
  "心跳回复": "services/host/heartbeat/",
  "打印任务下发": "services/host/print-dispatch/",
  "配液状态恢复": "services/host/state-restore/",
  "设备当前状态": "services/screen/device-status/",
  "开关量测试": "services/screen/dio-test/",
  "大体积测试": "services/screen/large-test/",
  "小体积测试": "services/screen/small-test/",
  "打印测试": "services/screen/print-test/",
  "灌装下发测试": "services/screen/fill-dispatch-test/",
  "固体试剂添加": "services/dispense/solid-addition/",
  "大体积加液": "services/dispense/large-dosing/",
  "小体积加液": "services/dispense/small-dosing/",
  "pH 测定/酸碱添加": "services/dispense/ph-and-acid-alkali/",
  "灌装下发通讯": "services/dispense/fill-dispatch-comm/",
  "电极清洗": "services/cleaning/electrode/",
  "配液桶清洗": "services/cleaning/tank/",
  "上传配液数据": "services/dispense/upload-data/",
  "大体积加液服务：加液/校准/清洗/填充": "services/programs/large-dosing-program/",
  "2 路酸碱服务：小体积加液/校准/清洗/填充/通路切换": "services/programs/acid-alkali-2ch-program/",
  "8 路小体积服务：加液/校准/清洗/填充": "services/programs/small-dosing-8ch-program/",
  "大肯机械臂（左）：固体添加/搅拌/夹爪清洗/初始化": "services/arms/daken-left/",
  "大肯机械臂（右）：电极校准/pH 测定/电极清洗/初始化": "services/arms/daken-right/",
  "清洗臂：配液桶清洗/吹干/初始化": "services/arms/cleaning-arm/",
  "pH 电极清洗": "services/cleaning/ph-electrode/",
  "夹爪清洗": "services/cleaning/gripper/",
  "大体积回路清洗": "services/cleaning/large-loop/",
  "小体积回路清洗": "services/cleaning/small-loop/",
  "旋切阀清洗": "services/cleaning/rotary-valve/",
  "小体积标定": "services/calibration/small/",
  "大体积标定": "services/calibration/large/",
  "pH 电极校准": "services/calibration/ph_calibration_requirements_v1.6.7/"
};

function ensureServiceLinks() {
  // 1) 卡片标题（不强制变链接；核心是列表项）
  document.querySelectorAll('.cards .card').forEach(card => {
    // 2) 列表项：逐条匹配
    const ul = card.querySelector('ul');
    if(!ul) return;
    Array.from(ul.querySelectorAll('li')).forEach(li => {
      const label = (li.textContent || '').trim();
      const href = LINK_MAP[label];
      if(href && !li.querySelector('a')) {
        const a = document.createElement('a');
        a.href = href; a.textContent = label;
        a.style.textDecoration = 'none'; a.style.color = 'inherit';
        li.innerHTML = ''; li.appendChild(a);
      }
    });
  });
}

// 首次渲染与搜索后都重新应用
const __origSearch = (typeof search === 'function') ? search : null;
if(__origSearch) {
  window.search = function(q) {
    __origSearch(q);
    ensureServiceLinks();
  };
}
document.addEventListener('DOMContentLoaded', ensureServiceLinks);
</script>

<!-- 配置同步调试功能 -->
<script>
// 调试功能
function debugBasics() {
  let result = '基础检查结果：<br>';
  
  result += `window.AUTH_CONFIG: ${!!window.AUTH_CONFIG}<br>`;
  result += `window.configSync: ${!!window.configSync}<br>`;
  result += `configSync.initialized: ${window.configSync?.initialized}<br>`;
  result += `localStorage配置: ${!!localStorage.getItem('fl510_docs_config')}<br>`;
  result += `GitHub Token: ${!!localStorage.getItem('github_sync_token')}<br>`;
  result += `Gist ID: ${!!localStorage.getItem('fl510_gist_id')}<br>`;
  
  document.getElementById('debug-basics-result').innerHTML = `<div class="debug-status">${result}</div>`;
}

async function debugTestToken() {
  const token = document.getElementById('debug-token').value.trim();
  if (!token) {
    document.getElementById('debug-token-result').innerHTML = '<div class="debug-error">请输入Token</div>';
    return;
  }

  document.getElementById('debug-token-result').innerHTML = '<div class="debug-info">正在测试Token...</div>';

  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (response.ok) {
      const user = await response.json();
      document.getElementById('debug-token-result').innerHTML = `<div class="debug-success">✅ Token有效！用户: ${user.login}</div>`;
      
      // 保存Token
      localStorage.setItem('github_sync_token', token);
      if (window.configSync) {
        window.configSync.githubToken = token;
      }
    } else {
      document.getElementById('debug-token-result').innerHTML = `<div class="debug-error">❌ Token无效，状态码: ${response.status}</div>`;
    }
  } catch (error) {
    document.getElementById('debug-token-result').innerHTML = `<div class="debug-error">❌ 网络错误: ${error.message}</div>`;
  }
}

async function debugTestSync() {
  document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">正在测试同步...</div>';
  
  try {
    if (window.configSync && window.configSync.syncConfig) {
      await window.configSync.syncConfig();
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-success">✅ 同步测试完成</div>';
    } else {
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-error">❌ configSync不可用</div>';
    }
  } catch (error) {
    document.getElementById('debug-sync-result').innerHTML = `<div class="debug-error">❌ 同步失败: ${error.message}</div>`;
  }
}

async function debugTestLoad() {
  document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">正在测试加载...</div>';
  
  try {
    if (window.configSync && window.configSync.loadConfig) {
      const config = await window.configSync.loadConfig();
      if (config) {
        document.getElementById('debug-sync-result').innerHTML = `<div class="debug-success">✅ 加载成功: ${JSON.stringify(config)}</div>`;
      } else {
        document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">⚠️ 没有云端配置</div>';
      }
    } else {
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-error">❌ configSync不可用</div>';
    }
  } catch (error) {
    document.getElementById('debug-sync-result').innerHTML = `<div class="debug-error">❌ 加载失败: ${error.message}</div>`;
  }
}

function debugAddUser() {
  try {
    let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
    if (!config.allowedUsers) config.allowedUsers = [];
    if (!config.adminUsers) config.adminUsers = [];

    const testUser = 'test-user-' + Date.now();
    config.allowedUsers.push(testUser);
    
    localStorage.setItem('fl510_docs_config', JSON.stringify(config));
    
    if (window.AUTH_CONFIG) {
      window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
    }

    document.getElementById('debug-config-result').innerHTML = `<div class="debug-success">✅ 添加测试用户: ${testUser}</div>`;
  } catch (error) {
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-error">❌ 添加用户失败: ${error.message}</div>`;
  }
}

function debugShowConfig() {
  try {
    const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-info"><pre>${JSON.stringify(config, null, 2)}</pre></div>`;
  } catch (error) {
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-error">❌ 显示配置失败: ${error.message}</div>`;
  }
}

function debugShowInfo() {
  let debug = '调试信息：<br><pre>';
  
  debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
  debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
  debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
  
  if (window.configSync) {
    debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
    debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
    debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
    debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
  }
  
  debug += '</pre>';
  document.getElementById('debug-info-result').innerHTML = `<div class="debug-info">${debug}</div>`;
}

// 添加调试按钮到导航
function addDebugButton() {
  const nav = document.querySelector('.nav');
  if (nav && !document.getElementById('debug-btn')) {
    const debugBtn = document.createElement('button');
    debugBtn.id = 'debug-btn';
    debugBtn.textContent = '🔧 调试';
    debugBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1000; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;';
    debugBtn.onclick = () => {
      const debugLayer = document.querySelector('[data-layer="debug"]');
      if (debugLayer) {
        debugLayer.style.display = debugLayer.style.display === 'none' ? 'block' : 'none';
      }
    };
    document.body.appendChild(debugBtn);
  }
}

// 页面加载完成后添加调试按钮
setTimeout(addDebugButton, 2000);

// 自动检查配置同步状态
function checkConfigSyncStatus() {
  console.log('Checking config sync status...');
  
  // 检查是否有GitHub Token
  const hasToken = !!localStorage.getItem('github_sync_token');
  const hasGistId = !!localStorage.getItem('fl510_gist_id');
  
  console.log('Sync status:', { hasToken, hasGistId, configSync: !!window.configSync });
  
  // 如果配置同步可用，尝试从服务器加载配置
  if (window.configSync && window.configSync.initialized && hasToken) {
    console.log('Attempting to load config from server...');
    window.configSync.loadConfig().then(config => {
      if (config && (config.allowedUsers || config.adminUsers)) {
        console.log('Server config loaded:', config);
        
        // 更新本地配置
        const currentConfig = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
        const mergedConfig = {
          allowedUsers: [...new Set([...(config.allowedUsers || []), ...(currentConfig.allowedUsers || [])])],
          adminUsers: [...new Set([...(config.adminUsers || []), ...(currentConfig.adminUsers || [])])]
        };
        
        localStorage.setItem('fl510_docs_config', JSON.stringify(mergedConfig));
        
        // 更新全局配置
        if (window.AUTH_CONFIG) {
          window.AUTH_CONFIG.allowedUsers = mergedConfig.allowedUsers;
          window.AUTH_CONFIG.adminUsers = mergedConfig.adminUsers;
        }
        
        console.log('Config merged and updated:', mergedConfig);
      }
    }).catch(error => {
      console.error('Failed to load config from server:', error);
    });
  }
}

// 页面加载完成后检查配置同步状态
setTimeout(checkConfigSyncStatus, 3000);
</script>

<!-- 调试样式 -->
<style>
.debug-panel { max-width: 800px; margin: 0 auto; }
.debug-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
.debug-btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
.debug-result { margin: 10px 0; }
.debug-status, .debug-info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; }
.debug-success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; }
.debug-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; }
</style>

<!-- 加载认证系统 -->
<script src="javascripts/auth-config.js?v=2024-10-20"></script>
<script src="javascripts/auth.js?v=2024-10-20"></script>
<script src="javascripts/admin.js?v=2024-10-20"></script>
<script src="javascripts/github-users.js?v=2024-10-20"></script>

</body>
</html>
