<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FLâ€‘510 è½¯ä»¶åˆ†å±‚åŠ¨æ•ˆå›¾ï¼ˆv5.3R4 ç¦»çº¿ï¼šRS485 å­é¡¹é€é¡¹ç¼©è¿›ï¼‰</title>
<style>
:root{
  --bg:#f8fafc; --card:#ffffff; --muted:#6b7280; --text:#111827; --border:#e5e7eb;
  --primary:#2563eb; --primary-fore:#ffffff; --radius:16px;
  --shadow: 0 8px 24px rgba(17,24,39,.06), 0 2px 8px rgba(17,24,39,.04);
  --mark-bg:#fde68a; --mark-fg:#111827;
  --error-bg:#fee2e2; --error-fg:#991b1b;
  --rail-bg:#fafafa;
}
[data-theme="dark"]{
  --bg:#0b1020; --card:#0f172a; --muted:#94a3b8; --text:#e5e7eb; --border:#243045;
  --primary:#60a5fa; --primary-fore:#0b1020; --shadow: 0 10px 28px rgba(2,6,23,.35), 0 2px 10px rgba(2,6,23,.3);
  --mark-bg:#4b5563; --mark-fg:#fff;
  --error-bg:#3f1d1d; --error-fg:#fecaca;
  --rail-bg:#0b1222;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:var(--bg)}
.container{max-width:1180px;margin:0 auto;padding:24px}
.errorbar{display:none;margin-bottom:12px;padding:10px 12px;border-radius:12px;background:var(--error-bg);color:var(--error-fg);border:1px solid var(--border)}
.topbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
.titlebox{border:1px solid var(--border);border-radius:calc(var(--radius)+4px);background:var(--card);padding:10px 14px;box-shadow:var(--shadow)}
.title{font-weight:700;font-size:18px;line-height:1.2}
.subtitle{font-size:12px;color:var(--muted);margin-top:2px}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);padding:8px 12px;border-radius:12px;cursor:pointer;transition:.2s box-shadow,.2s transform;color:var(--text)}
.btn:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.btn.primary{background:var(--primary);border-color:var(--primary);color:var(--primary-fore)}
.btn.secondary{background:#f3f4f6;color:#111827}
[data-theme="dark"] .btn.secondary{background:#0b1222;color:var(--text)}
.icon{width:16px;height:16px;display:inline-block}
.input{position:relative;display:inline-flex;align-items:center}
.input input{width:260px;padding:9px 12px 9px 32px;border-radius:12px;border:1px solid var(--border);background:var(--card);outline:none;color:var(--text)}
.input svg{position:absolute;left:10px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 360px;gap:16px;position:relative}
@media (max-width:980px){.grid{grid-template-columns:1fr} .input input{width:100%}}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.layer{border-radius:var(--radius);border:1px dashed var(--border);background:linear-gradient(180deg,#f9fafb,#f3f4f6);padding:14px;box-shadow:var(--shadow)}
[data-theme="dark"] .layer{background:linear-gradient(180deg,#0f172a,#0b1222)}
.layer-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
.layer-title{font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px}
.layer-sub{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:var(--primary);color:var(--primary-fore);font-weight:700;font-size:12px;line-height:1}
.count{margin-left:8px}
.toggle{cursor:pointer;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#f9fafb;color:#111827}
[data-theme="dark"] .toggle{background:#0b1222;color:var(--text)}
.layer-body{overflow:hidden;transition:max-height .45s ease}
.pill{font-size:12px;color:#374151;background:#f9fafb;border:1px solid var(--border);padding:6px 10px;border-radius:999px;display:inline-block}
[data-theme="dark"] .pill{background:#0b1222;color:var(--text)}
.cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
@media (max-width:980px){.cards{grid-template-columns:1fr}}
.card{border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--card)}
.card h4{margin:0 0 6px 0;font-size:13px}
.meta{font-size:12px;color:var(--muted);margin-top:4px}
ul{margin:6px 0 0 16px;padding:0}
li{margin:4px 0;font-size:13px}
.rail{position:sticky;top:12px}
.rail h3{margin:0 0 8px 0;font-size:14px}
.muted{color:var(--muted)}
.empty{font-size:13px;color:var(--muted);padding:8px}
.tint-ui{background:linear-gradient(180deg,#f5f3ff,#f2efff)}
.tint-services{background:linear-gradient(180deg,#fff7ed,#fff3da)}
.tint-functional{background:linear-gradient(180deg,#ecfeff,#e6fbff)}
.tint-drivers{background:linear-gradient(180deg,#f8fafc,#eef2f7)}
[data-theme="dark"] .tint-ui{background:linear-gradient(180deg,#13122a,#110f22)}
[data-theme="dark"] .tint-services{background:linear-gradient(180deg,#1f172a,#171222)}
[data-theme="dark"] .tint-functional{background:linear-gradient(180deg,#0f1f2a,#0b1822)}
[data-theme="dark"] .tint-drivers{background:linear-gradient(180deg,#0f172a,#0b1222)}
mark{background:var(--mark-bg);color:var(--mark-fg);padding:0 .12em;border-radius:4px}
/* æ’­æ”¾å¼ºè°ƒ */
.pulse{animation:pulse .9s ease-out 1}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(37,99,235,.35)}100%{box-shadow:0 0 0 18px rgba(37,99,235,0)}}
/* Tree styles */
.tree{list-style:none;margin:0;padding:0;display:grid;gap:6px}
.tree .row{display:flex;align-items:flex-start;gap:8px;padding:8px;border:1px solid var(--border);border-radius:10px;background:var(--rail-bg)}
.tree .row .label{display:flex;flex-direction:column}
.tree .row .name{font-weight:600;font-size:13px}
.tree .row .meta{font-size:12px;color:var(--muted);margin-top:2px}
.tree .twisty{width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;user-select:none;transition:transform .2s}
.tree .twisty::after{content:"â€º";font-size:12px;line-height:1;transform:rotate(0deg);display:inline-block}
.tree .node.open>.row .twisty::after{transform:rotate(90deg)}
.tree .children{margin-left:22px;margin-top:6px;padding-left:10px;border-left:1px dashed var(--border);display:none}
.tree .node.open>.children{display:block}
.tree .leaf .dot{width:6px;height:6px;border-radius:999px;background:var(--primary);margin-top:6px}
@media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
@media print{ @page{size:A4 landscape;margin:10mm} .btn,.controls,.rail{display:none!important} .layer{break-inside:avoid;page-break-inside:avoid} }
</style>
</head>
<body>
<div class="container">
  <div id="err" class="errorbar"></div>
  <div class="topbar">
    <div class="titlebox">
      <div class="title">FLâ€‘510 è½¯ä»¶åˆ†å±‚ï¼ˆv1.0R2ï¼‰</div>
      <div class="subtitle">é¡ºåºæ ‡æ³¨ Â· æœç´¢é«˜äº® Â· æ·±è‰²ä¸»é¢˜ Â· ä¸²è¡ŒåŠ¨ç”»æ’­æ”¾ Â· é€šä¿¡ä¸åè®®å±‚çº§å±•ç¤ºï¼ˆå« RS485 é€é¡¹ï¼‰</div>
    </div>
    <div class="controls">
      <span id="playCount" class="muted">å°šæœªæ’­æ”¾</span>
      <span class="muted">Â·</span>
      <div class="input">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input id="searchInput" placeholder="æœç´¢ï¼šå¦‚ 'pH' / 'åŠ æ¶²' / 'RS485' â€¦" />
      </div>
      <button id="playBtn" class="btn primary"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> æ’­æ”¾</button>
      <button id="toggleAllBtn" class="btn secondary"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h16v4H4z"/></svg> å…¨éƒ¨æŠ˜å </button>
      <button id="themeBtn" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> ä¸»é¢˜ï¼šæµ…è‰²</button>
      <button id="printBtn" class="btn"><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M6 9V2h12v7m-2 5h2a2 2 0 0 1 2 2v4H4v-4a2 2 0 0 1 2-2h2"/></svg> æ‰“å° / å¯¼å‡º PDF</button>
    </div>
  </div>

  <div class="grid" id="capture-area">
    <div id="layersCol" class="panel"></div>
    <aside class="panel rail">
      <h3>é€šä¿¡ä¸åè®®</h3>
      <ul id="commsTree" class="tree"></ul>
    </aside>
  </div>
</div>

<script>
(function(){
  const bar = document.getElementById('err');
  function show(msg){ bar.style.display='block'; bar.innerHTML = '<strong>è„šæœ¬æç¤ºï¼š</strong> ' + msg; }
  window.addEventListener('error', e => { show(e.message); });
  window.addEventListener('unhandledrejection', e => { show('Promise é”™è¯¯ï¼š' + (e.reason && e.reason.message || e.reason)); });
})();
</script>
<script>
// é¡ºåºï¼šâ‘  ä¸Šä½æœºä¸æ˜¾ç¤ºå±‚ â†’ â‘¡ æœåŠ¡å±‚ â†’ â‘¢ åŠŸèƒ½é©±åŠ¨å±‚ â†’ â‘£ åº•å±‚é©±åŠ¨å±‚
const DATA = {
  layers: [
    { id:"ui", name:"ä¸Šä½æœºä¸æ˜¾ç¤ºå±‚", subtitle:"äººæœºç•Œé¢ã€ä»»åŠ¡ä¸‹å‘ä¸è®¾å¤‡æµ‹è¯•", tint:"tint-ui", kind:"items",
      items:[
        { name:"ä¸Šä½æœºæœåŠ¡", items:["é…æ¶²ä»»åŠ¡ä¸‹å‘","å¿ƒè·³å›å¤","æ‰“å°ä»»åŠ¡ä¸‹å‘","é…æ¶²çŠ¶æ€æ¢å¤"] },
        { name:"æ˜¾ç¤ºå±æœåŠ¡", items:["è®¾å¤‡å½“å‰çŠ¶æ€","å¼€å…³é‡æµ‹è¯•","å¤§ä½“ç§¯æµ‹è¯•","å°ä½“ç§¯æµ‹è¯•","æ‰“å°æµ‹è¯•","çŒè£…ä¸‹å‘æµ‹è¯•"] }
      ]
    },
    { id:"services", name:"æœåŠ¡å±‚", subtitle:"é¢å‘æµç¨‹çš„ä¸šåŠ¡ç¼–æ’", tint:"tint-services", kind:"buckets",
      buckets:[
        { title:"é…æ¶²æœåŠ¡", items:["å›ºä½“è¯•å‰‚æ·»åŠ ","å¤§ä½“ç§¯åŠ æ¶²","å°ä½“ç§¯åŠ æ¶²","pH æµ‹å®š/é…¸ç¢±æ·»åŠ ","çŒè£…ä¸‹å‘é€šè®¯","ç”µææ¸…æ´—","é…æ¶²æ¡¶æ¸…æ´—","ä¸Šä¼ é…æ¶²æ•°æ®"] },
        { title:"åŠ æ¶²æœåŠ¡ç¨‹åº", items:["å¤§ä½“ç§¯åŠ æ¶²æœåŠ¡ï¼šåŠ æ¶²/æ ¡å‡†/å¡«å……","2 è·¯é…¸ç¢±æœåŠ¡ï¼šå°ä½“ç§¯åŠ æ¶²/æ ¡å‡†/æ¸…æ´—/å¡«å……/é€šè·¯åˆ‡æ¢","8 è·¯å°ä½“ç§¯æœåŠ¡ï¼šåŠ æ¶²/æ ¡å‡†/å¡«å……"] },
        { title:"æœºæ¢°è‡‚/æœ«ç«¯æœåŠ¡", items:["å¤§è‚¯æœºæ¢°è‡‚ï¼ˆå·¦ï¼‰ï¼šå›ºä½“æ·»åŠ /æ…æ‹Œ/å¤¹çˆªæ¸…æ´—/åˆå§‹åŒ–","å¤§è‚¯æœºæ¢°è‡‚ï¼ˆå³ï¼‰ï¼šç”µææ ¡å‡†/pH æµ‹å®š/ç”µææ¸…æ´—/åˆå§‹åŒ–","æ¸…æ´—è‡‚ï¼šé…æ¶²æ¡¶æ¸…æ´—/å¹å¹²/åˆå§‹åŒ–"] },
        { title:"æ¸…æ´—æœåŠ¡ï¼ˆé€šç”¨ï¼‰", items:["pH ç”µææ¸…æ´—","é…æ¶²æ¡¶æ¸…æ´—","å¤¹çˆªæ¸…æ´—","å¤§ä½“ç§¯å›è·¯æ¸…æ´—","å°ä½“ç§¯å›è·¯æ¸…æ´—","æ—‹åˆ‡é˜€æ¸…æ´—"] },
        { title:"æ ‡å®šæœåŠ¡", items:["å°ä½“ç§¯æ ‡å®š","å¤§ä½“ç§¯æ ‡å®š","pH ç”µææ ¡å‡†"] }
      ]
    },
    { id:"functional", name:"åŠŸèƒ½é©±åŠ¨å±‚", subtitle:"æŠŠåŸå­é©±åŠ¨ç»„åˆä¸ºå¯å¤ç”¨åŠŸèƒ½å—", tint:"tint-functional", kind:"groups",
      groups:[
        { name:"é…¸ç¢±åŠ æ¶²ï¼ˆ2 è·¯ 10 é€šé“ï¼‰", items:["æ³¨å°„æ³µé©±åŠ¨","åŠ æ¶²è‡‚é©±åŠ¨"], link:"services/programs/acid-alkali-2ch-program.md" },
        { name:"å°ä½“ç§¯åŠ æ¶²ï¼ˆ8 è·¯ï¼‰", items:["æ³¨å°„æ³µé©±åŠ¨","åŠ æ¶²è‡‚é©±åŠ¨"], link:"services/programs/small-dosing-8ch-program.md" },
        { name:"å¤§ä½“ç§¯åŠ æ¶²ï¼ˆ4 è·¯ï¼‰", items:["å¤§ä½“ç§¯åŠ æ¶²é©±åŠ¨","å¼€å…³é‡é©±åŠ¨","ç®¡è·¯æ£€æµ‹ï¼ˆæ¶²ä½ï¼‰"], link:"services/programs/large-dosing-program.md" },
        { name:"æ¸…æ´—è‡‚", items:["æ¸…æ´—è‡‚é©±åŠ¨","å¼€å…³é‡é©±åŠ¨"], link:"services/cleaning/cleaning-arm.md" },
        { name:"å¤§è‚¯æœºæ¢°è‡‚ï¼ˆå·¦/å³ï¼‰", items:["å¤§è‚¯æœºæ¢°è‡‚é©±åŠ¨","å¤¹çˆªé©±åŠ¨","pH ç”µæé©±åŠ¨"], link:"services/arms/daken-left.md" },
        { name:"è¯•å‰‚æ£€æµ‹", items:["RS485"], link:"services/calibration/large.md" },
        { name:"ç®¡è·¯æ£€æµ‹ï¼ˆæ¶²ä½ï¼‰", items:["ç›´é©±"], link:"services/calibration/small.md" }
      ]
    },
    { id:"drivers", name:"åº•å±‚é©±åŠ¨å±‚", subtitle:"è®¾å¤‡ä¸æ‰§è¡Œå™¨çš„ç›´æ¥é©±åŠ¨", tint:"tint-drivers", kind:"items",
      items:[
        { name:"æ³¨å°„æ³µé©±åŠ¨", meta:"RS485", link:"services/dispense/small-dosing.md" },
        { name:"åŠ æ¶²è‡‚é©±åŠ¨", meta:"Modbus Slave", link:"services/dispense/large-dosing.md" },
        { name:"pH ç”µæé©±åŠ¨", meta:"RS485", link:"services/calibration/ph-electrode.md" },
        { name:"å¤šè·¯æ—‹åˆ‡é˜€é©±åŠ¨", meta:"RS485", link:"services/cleaning/rotary-valve.md" },
        { name:"å¤¹çˆªé©±åŠ¨", meta:"Modbus Slave", link:"services/cleaning/gripper.md" },
        { name:"å¤§è‚¯æœºæ¢°è‡‚é©±åŠ¨", meta:"Modbus Slave", link:"services/arms/é«˜ç²¾åº¦å›é›¶æ–¹æ³•ï¼šæŒ¡ç‰‡ä¸­å¿ƒå®šä½æ³•è¯¦è§£.md" },
        { name:"å¤§ä½“ç§¯åŠ æ¶²é©±åŠ¨", meta:"ç›´é©±", link:"services/dispense/large-dosing.md" },
        { name:"å¼€å…³é‡é©±åŠ¨", meta:"ç›´é©±ï¼ˆæ³µ/é˜€/åŠ çƒ­/è¶…å£°/æ’é£ï¼‰", link:"services/screen/dio-test.md" }
      ]
    }
  ],
  commsTree:[
    { name:"ä¸»æœºé€šè®¯", meta:"TCP/IP", children:[
      { name:"JSON åè®®", meta:"åŸºäº TCP/IPï¼›ç”¨äºä¸»æœºé€šè®¯ / è¯•å‰‚æ£€æµ‹" }
    ]},
    { name:"ä»æœºé€šè®¯", meta:"RS485ï¼ˆç°åœºæ€»çº¿ï¼‰", children:[
      { name:"Modbus RTUï¼ˆä»æœºï¼‰", meta:"", children:[
        { name:"åŠ æ¶²è‡‚é©±åŠ¨" }, { name:"å¤¹çˆªé©±åŠ¨" }, { name:"å¤§è‚¯æœºæ¢°è‡‚é©±åŠ¨" }
      ]},
      { name:"è‡ªç”±åè®®", meta:"", children:[
        { name:"æ³¨å°„æ³µé©±åŠ¨" }, { name:"pH ç”µæé©±åŠ¨" }, { name:"å¤šè·¯æ—‹åˆ‡é˜€é©±åŠ¨" }
      ]}
    ] },
    { name:"æ˜¾ç¤ºå±é€šè®¯", meta:"å¤§å½©é€šè®¯ï¼ˆé¢„ç•™ï¼‰", children:[] }
  ]
};
</script>
<script>
const layersCol = document.getElementById('layersCol');
const commsTree = document.getElementById('commsTree');
const searchInput = document.getElementById('searchInput');
const playBtn = document.getElementById('playBtn');
const toggleAllBtn = document.getElementById('toggleAllBtn');
const playCount = document.getElementById('playCount');
const themeBtn = document.getElementById('themeBtn');
const printBtn = document.getElementById('printBtn');

let expandedAll = true, playTimes = 0, currentQuery = '';

// åº•â†’ä¸Šæ’­æ”¾é¡ºåº
const PLAY_ORDER = ['drivers','functional','services','ui'];
const STEP_MS = 650; // æ¯å±‚é—´éš”

const circled = n => ({1:'â‘ ',2:'â‘¡',3:'â‘¢',4:'â‘£'}[n] || String(n));

function h(tag, attrs={}, ...children){
  const el = document.createElement(tag);
  for(const k in attrs){
    if(k === 'class') el.className = attrs[k];
    else if(k === 'style') Object.assign(el.style, attrs[k]);
    else if(k.startsWith('on') && typeof attrs[k]==='function') el.addEventListener(k.slice(2).toLowerCase(), attrs[k]);
    else if(k === 'dataset'){ for(const dk in attrs[k]) el.dataset[dk] = attrs[k][dk]; }
    else el.setAttribute(k, attrs[k]);
  }
  children.flat().forEach(c=>{
    if(c===null||c===undefined) return;
    if(typeof c === 'string') el.appendChild(document.createTextNode(c));
    else el.appendChild(c);
  });
  return el;
}
const keyify = s => (s||'').toString().trim().toLowerCase();
const toSearchText = s => keyify(s);

function escapeHtml(str){
  return (str+'').replace(/[&<>'"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[s]));
}
function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
function highlightText(text, q){
  if(!q) return escapeHtml(text);
  const re = new RegExp('(' + escapeRegExp(q) + ')', 'ig');
  return escapeHtml(text).replace(re, '<mark>$1</mark>');
}

function buildItemCard(layerId, title, meta=null, list=null, link=null){
  const card = h('div', {class:'card', dataset:{layer:layerId, rawTitle:title, rawMeta:meta||'', rawList:JSON.stringify(list||[])}});
  
  // å¦‚æœæœ‰é“¾æ¥ï¼Œæ·»åŠ ç‚¹å‡»äº‹ä»¶
  if(link){
    card.style.cursor = 'pointer';
    card.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      console.log('ç‚¹å‡»é“¾æ¥:', link);
      // ç¡®ä¿é“¾æ¥æ˜¯ç›¸å¯¹è·¯å¾„
      const fullLink = link.startsWith('http') ? link : './' + link;
      window.open(fullLink, '_blank');
    });
  }
  
  const h4 = h('h4', {}); h4.innerHTML = highlightText(title, currentQuery);
  card.appendChild(h4);
  if(meta){ const m = h('div', {class:'meta'}); m.innerHTML = highlightText(meta, currentQuery); card.appendChild(m); }
  if(Array.isArray(list) && list.length){
    const ul = h('ul');
    list.forEach(x => { const li = h('li'); li.innerHTML = highlightText(x, currentQuery); ul.appendChild(li); });
    card.appendChild(ul);
  }
  card.dataset.search = toSearchText([title, meta, ...(list||[])].join(' '));
  return card;
}

function buildLayer(layer, rank){
  const layerEl = document.createElement('section');
  layerEl.className = 'layer ' + layer.tint;
  layerEl.dataset.id = layer.id;
  const countSpan = h('span', {class:'pill count', style:{display:'none'}}, '');
  const head = h('div', {class:'layer-head'},
    h('div', {},
      h('div', {class:'layer-title'},
        h('span', {class:'badge'}, circled(rank+1)),
        layer.name,
        countSpan
      ),
      h('div', {class:'layer-sub'}, layer.subtitle)
    ),
    h('button', {class:'toggle', onclick:() => toggleOne(layerEl)}, expandedAll ? 'æŠ˜å ' : 'å±•å¼€')
  );
  const body = h('div', {class:'layer-body'});
  const cards = h('div', {class:'cards'});
  if(layer.kind === 'items'){
    (layer.items||[]).forEach(it => cards.appendChild(buildItemCard(layer.id, it.name||it.meta, it.meta||null, it.items||null, it.link||null)));
  }else if(layer.kind === 'groups'){
    (layer.groups||[]).forEach(g => cards.appendChild(buildItemCard(layer.id, g.name, null, g.items||[], g.link||null)));
  }else if(layer.kind === 'buckets'){
    (layer.buckets||[]).forEach(b => cards.appendChild(buildItemCard(layer.id, b.title, null, b.items||[], b.link||null)));
  }
  body.appendChild(cards);
  requestAnimationFrame(()=>{ body.style.maxHeight = expandedAll ? (body.scrollHeight+'px') : '0px'; });
  layerEl.appendChild(head); layerEl.appendChild(body);
  return layerEl;
}

function renderLayers(){
  layersCol.innerHTML = '';
  DATA.layers.forEach((layer, idx) => layersCol.appendChild(buildLayer(layer, idx)));
}

// é€’å½’æ„å»ºæ ‘èŠ‚ç‚¹
function buildTreeNode(node){
  const li = h('li', {class:'node open', dataset:{search: toSearchText(node.name + ' ' + (node.meta||'')), rawName: node.name, rawMeta: node.meta||''}});
  const row = h('div', {class:'row'});
  const twist = h('button', {class:'twisty', onclick: (e)=>{ e.stopPropagation(); li.classList.toggle('open'); }});
  const label = h('div', {class:'label'});
  const name = h('div', {class:'name'}); name.innerHTML = highlightText(node.name, currentQuery);
  const meta = h('div', {class:'meta'}); meta.innerHTML = highlightText(node.meta||'', currentQuery);
  label.appendChild(name); if(node.meta) label.appendChild(meta);
  row.appendChild(twist); row.appendChild(label);
  li.appendChild(row);
  if(node.children && node.children.length){
    const ul = h('ul', {class:'children'});
    node.children.forEach(ch => {
      if(ch.children && ch.children.length){
        ul.appendChild(buildTreeNode(ch));
      }else{
        ul.appendChild(buildTreeLeaf(ch));
      }
    });
    li.appendChild(ul);
  }
  return li;
}
function buildTreeLeaf(leaf){
  const li = h('li', {class:'leaf', dataset:{search: toSearchText(leaf.name + ' ' + (leaf.meta||'')), rawName: leaf.name, rawMeta: leaf.meta||''}});
  const row = h('div', {class:'row'});
  const dot = h('div', {class:'dot'});
  const label = h('div', {class:'label'});
  const name = h('div', {class:'name'}); name.innerHTML = highlightText(leaf.name, currentQuery);
  const meta = h('div', {class:'meta'}); meta.innerHTML = highlightText(leaf.meta||'', currentQuery);
  label.appendChild(name); if(leaf.meta) label.appendChild(meta);
  row.appendChild(dot); row.appendChild(label);
  li.appendChild(row);
  return li;
}
function renderComms(){
  commsTree.innerHTML = '';
  DATA.commsTree.forEach(n => commsTree.appendChild(buildTreeNode(n)));
}

function getLayerEl(id){ return document.querySelector('.layer[data-id="'+id+'"]'); }
function collapseLayer(id){
  const el = getLayerEl(id); if(!el) return;
  const body = el.querySelector('.layer-body'); const btn = el.querySelector('.toggle');
  body.style.maxHeight = '0px'; btn.textContent = 'å±•å¼€';
}
function expandLayer(id){
  const el = getLayerEl(id); if(!el) return;
  const body = el.querySelector('.layer-body'); const btn = el.querySelector('.toggle');
  body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = 'æŠ˜å ';
  el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse');
  const r = el.getBoundingClientRect();
  if(r.top < 80 || r.bottom > window.innerHeight){
    window.scrollTo({ top: window.scrollY + r.top - 70, behavior: 'smooth' });
  }
}

function toggleOne(layerEl){
  const body = layerEl.querySelector('.layer-body');
  const btn = layerEl.querySelector('.toggle');
  const isOpen = parseInt(body.style.maxHeight||'0') > 0;
  if(isOpen){ body.style.maxHeight = '0px'; btn.textContent = 'å±•å¼€'; }
  else { body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = 'æŠ˜å '; }
}

function setAll(expand){
  expandedAll = expand;
  toggleAllBtn.innerHTML = expand
    ? '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h16v4H4z"/></svg> å…¨éƒ¨æŠ˜å '
    : '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7h16M4 12h16M4 17h16"/></svg> å…¨éƒ¨å±•å¼€';
  DATA.layers.forEach(l=> expand ? expandLayer(l.id) : collapseLayer(l.id));
}

function updateCountsAndAutoExpand(q){
  const hasQ = !!q;
  document.querySelectorAll('.layer').forEach(layerEl=>{
    const cards = layerEl.querySelectorAll('.cards .card');
    let visibleCount = 0;
    cards.forEach(card=>{ if(card.style.display !== 'none') visibleCount++; });
    const pill = layerEl.querySelector('.count');
    if(hasQ){ pill.style.display = ''; pill.textContent = 'Â· ' + visibleCount; }
    else { pill.style.display = 'none'; pill.textContent = ''; }
    const body = layerEl.querySelector('.layer-body');
    const btn = layerEl.querySelector('.toggle');
    if(hasQ){
      if(visibleCount>0){ body.style.maxHeight = body.scrollHeight + 'px'; btn.textContent = 'æŠ˜å '; }
      else { body.style.maxHeight = '0px'; btn.textContent = 'å±•å¼€'; }
    }
  });
}

function search(q){
  currentQuery = (q||'').trim();
  const key = toSearchText(currentQuery);
  // å±‚å†…å®¹å¡ç‰‡è¿‡æ»¤
  document.querySelectorAll('.cards .card').forEach(card=>{
    const ok = card.dataset.search.includes(key);
    card.style.display = ok ? '' : 'none';
    const title = card.querySelector('h4');
    if(title){ title.innerHTML = highlightText(card.dataset.rawTitle, currentQuery); }
    const metaEl = card.querySelector('.meta');
    if(metaEl){ metaEl.innerHTML = highlightText(card.dataset.rawMeta, currentQuery); }
    const ul = card.querySelector('ul');
    if(ul){
      const raws = JSON.parse(card.dataset.rawList||'[]');
      ul.innerHTML = '';
      raws.forEach(x=>{ const li = document.createElement('li'); li.innerHTML = highlightText(x, currentQuery); ul.appendChild(li); });
    }
  });
  updateCountsAndAutoExpand(currentQuery);

  // é€šä¿¡æ ‘è¿‡æ»¤ï¼ˆé€’å½’ï¼šéšè—æ‰€æœ‰ä¸åŒ¹é…çš„å¶å­ï¼Œæ˜¾ç¤ºå…¶ç¥–å…ˆèŠ‚ç‚¹ï¼Œå¹¶åœ¨æœç´¢æ—¶è‡ªåŠ¨å…¨éƒ¨å±•å¼€ï¼‰
  const leaves = Array.from(commsTree.querySelectorAll('.leaf'));
  let any = false;
  leaves.forEach(leaf=>{
    const ok = (leaf.dataset.search||'').includes(key);
    leaf.style.display = ok || !key ? '' : 'none';
    const nameEl = leaf.querySelector('.name');
    const metaEl = leaf.querySelector('.meta');
    if(nameEl){ nameEl.innerHTML = highlightText(leaf.dataset.rawName||'', currentQuery); }
    if(metaEl){ metaEl.innerHTML = highlightText(leaf.dataset.rawMeta||'', currentQuery); }
    if(ok) any = true;
  });
  const allNodes = Array.from(commsTree.querySelectorAll('.node'));
  allNodes.forEach(n=>{
    const nodeMatch = (n.dataset.search||'').includes(key);
    // å­å­™æ˜¯å¦æœ‰å¯è§å¶å­
    const hasVisibleLeaf = n.querySelector('.leaf:not([style*="display: none"])') !== null;
    const visible = key ? (nodeMatch || hasVisibleLeaf) : true;
    n.style.display = visible ? '' : 'none';
    const nameEl = n.querySelector(':scope > .row .name');
    const metaEl = n.querySelector(':scope > .row .meta');
    if(nameEl){ nameEl.innerHTML = highlightText(n.dataset.rawName||'', currentQuery); }
    if(metaEl){ metaEl.innerHTML = highlightText(n.dataset.rawMeta||'', currentQuery); }
    if(key){
      n.classList.add('open'); // æœç´¢æ—¶ç»Ÿä¸€å±•å¼€ï¼Œä¾¿äºæŸ¥çœ‹
    }else{
      n.classList.add('open');
    }
  });

  // å®šä½ç¬¬ä¸€ä¸ªå¯è§å‘½ä¸­
  if(currentQuery){
    const first = document.querySelector('.cards .card:not([style*="display: none"])') || commsTree.querySelector('.leaf:not([style*="display: none"])');
    if(first){
      const r = first.getBoundingClientRect();
      if(r.top < 0 || r.bottom > window.innerHeight){
        window.scrollTo({ top: window.scrollY + r.top - 80, behavior: 'smooth' });
      }
    }
  }
}

// æ’­æ”¾ï¼šå…ˆæŠ˜å å…¨éƒ¨ï¼Œå†æŒ‰ â‘£â†’â‘¢â†’â‘¡â†’â‘  é€å±‚å±•å¼€
function play(){
  playTimes += 1; playCount.textContent = 'ç¬¬ ' + playTimes + ' æ¬¡æ’­æ”¾';
  DATA.layers.forEach(l=> collapseLayer(l.id));
  let t = 0; PLAY_ORDER.forEach(id=>{ setTimeout(()=> expandLayer(id), t); t += STEP_MS; });
}

function toggleTheme(){
  const html = document.documentElement;
  const next = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', next);
  themeBtn.innerHTML = (next === 'dark')
    ? '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> ä¸»é¢˜ï¼šæ·±è‰²'
    : '<svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a9 9 0 1 0 9 9c0-4.97-4.03-9-9-9z"/></svg> ä¸»é¢˜ï¼šæµ…è‰²';
}

// events
playBtn.addEventListener('click', play);
toggleAllBtn.addEventListener('click', ()=> setAll(!expandedAll));
searchInput.addEventListener('input', e=> search(e.target.value));
themeBtn.addEventListener('click', toggleTheme);
printBtn.addEventListener('click', ()=> window.print());

// init
function render(){
  renderLayers();
  renderComms();
}
render();
setTimeout(()=> setAll(true), 0);
</script>

<script>
// è‡ªåŠ¨ä¸º"æœåŠ¡"æ¡ç›®åŠ é“¾æ¥ï¼ˆç‚¹å‡»è·³è½¬åˆ°å¯¹åº” Markdown é¡µé¢ï¼‰
const LINK_MAP = {
  "é…æ¶²ä»»åŠ¡ä¸‹å‘": "services/host/dispense-task/",
  "å¿ƒè·³å›å¤": "services/host/heartbeat/",
  "æ‰“å°ä»»åŠ¡ä¸‹å‘": "services/host/print-dispatch/",
  "é…æ¶²çŠ¶æ€æ¢å¤": "services/host/state-restore/",
  "è®¾å¤‡å½“å‰çŠ¶æ€": "services/screen/device-status/",
  "å¼€å…³é‡æµ‹è¯•": "services/screen/dio-test/",
  "å¤§ä½“ç§¯æµ‹è¯•": "services/screen/large-test/",
  "å°ä½“ç§¯æµ‹è¯•": "services/screen/small-test/",
  "æ‰“å°æµ‹è¯•": "services/screen/print-test/",
  "çŒè£…ä¸‹å‘æµ‹è¯•": "services/screen/fill-dispatch-test/",
  "å›ºä½“è¯•å‰‚æ·»åŠ ": "services/dispense/solid-addition/",
  "å¤§ä½“ç§¯åŠ æ¶²": "services/dispense/large-dosing/",
  "å°ä½“ç§¯åŠ æ¶²": "services/dispense/small-dosing/",
  "pH æµ‹å®š/é…¸ç¢±æ·»åŠ ": "services/dispense/ph-and-acid-alkali/",
  "çŒè£…ä¸‹å‘é€šè®¯": "services/dispense/fill-dispatch-comm/",
  "ç”µææ¸…æ´—": "services/cleaning/electrode/",
  "é…æ¶²æ¡¶æ¸…æ´—": "services/cleaning/tank/",
  "ä¸Šä¼ é…æ¶²æ•°æ®": "services/dispense/upload-data/",
  "å¤§ä½“ç§¯åŠ æ¶²æœåŠ¡ï¼šåŠ æ¶²/æ ¡å‡†/æ¸…æ´—/å¡«å……": "services/programs/large-dosing-program/",
  "2 è·¯é…¸ç¢±æœåŠ¡ï¼šå°ä½“ç§¯åŠ æ¶²/æ ¡å‡†/æ¸…æ´—/å¡«å……/é€šè·¯åˆ‡æ¢": "services/programs/acid-alkali-2ch-program/",
  "8 è·¯å°ä½“ç§¯æœåŠ¡ï¼šåŠ æ¶²/æ ¡å‡†/æ¸…æ´—/å¡«å……": "services/programs/small-dosing-8ch-program/",
  "å¤§è‚¯æœºæ¢°è‡‚ï¼ˆå·¦ï¼‰ï¼šå›ºä½“æ·»åŠ /æ…æ‹Œ/å¤¹çˆªæ¸…æ´—/åˆå§‹åŒ–": "services/arms/daken-left/",
  "å¤§è‚¯æœºæ¢°è‡‚ï¼ˆå³ï¼‰ï¼šç”µææ ¡å‡†/pH æµ‹å®š/ç”µææ¸…æ´—/åˆå§‹åŒ–": "services/arms/daken-right/",
  "æ¸…æ´—è‡‚ï¼šé…æ¶²æ¡¶æ¸…æ´—/å¹å¹²/åˆå§‹åŒ–": "services/arms/cleaning-arm/",
  "pH ç”µææ¸…æ´—": "services/cleaning/ph-electrode/",
  "å¤¹çˆªæ¸…æ´—": "services/cleaning/gripper/",
  "å¤§ä½“ç§¯å›è·¯æ¸…æ´—": "services/cleaning/large-loop/",
  "å°ä½“ç§¯å›è·¯æ¸…æ´—": "services/cleaning/small-loop/",
  "æ—‹åˆ‡é˜€æ¸…æ´—": "services/cleaning/rotary-valve/",
  "å°ä½“ç§¯æ ‡å®š": "services/calibration/small/",
  "å¤§ä½“ç§¯æ ‡å®š": "services/calibration/large/",
  "pH ç”µææ ¡å‡†": "services/calibration/ph_calibration_requirements_v1.6.7/"
};

function ensureServiceLinks() {
  // 1) å¡ç‰‡æ ‡é¢˜ï¼ˆä¸å¼ºåˆ¶å˜é“¾æ¥ï¼›æ ¸å¿ƒæ˜¯åˆ—è¡¨é¡¹ï¼‰
  document.querySelectorAll('.cards .card').forEach(card => {
    // 2) åˆ—è¡¨é¡¹ï¼šé€æ¡åŒ¹é…
    const ul = card.querySelector('ul');
    if(!ul) return;
    Array.from(ul.querySelectorAll('li')).forEach(li => {
      const label = (li.textContent || '').trim();
      const href = LINK_MAP[label];
      if(href && !li.querySelector('a')) {
        const a = document.createElement('a');
        a.href = href; a.textContent = label;
        a.style.textDecoration = 'none'; a.style.color = 'inherit';
        li.innerHTML = ''; li.appendChild(a);
      }
    });
  });
}

// é¦–æ¬¡æ¸²æŸ“ä¸æœç´¢åéƒ½é‡æ–°åº”ç”¨
const __origSearch = (typeof search === 'function') ? search : null;
if(__origSearch) {
  window.search = function(q) {
    __origSearch(q);
    ensureServiceLinks();
  };
}
document.addEventListener('DOMContentLoaded', ensureServiceLinks);
</script>

<!-- é…ç½®åŒæ­¥è°ƒè¯•åŠŸèƒ½ -->
<script>
// è°ƒè¯•åŠŸèƒ½
function debugBasics() {
  let result = 'åŸºç¡€æ£€æŸ¥ç»“æœï¼š<br>';
  
  result += `window.AUTH_CONFIG: ${!!window.AUTH_CONFIG}<br>`;
  result += `window.configSync: ${!!window.configSync}<br>`;
  result += `configSync.initialized: ${window.configSync?.initialized}<br>`;
  result += `localStorageé…ç½®: ${!!localStorage.getItem('fl510_docs_config')}<br>`;
  result += `GitHub Token: ${!!localStorage.getItem('github_sync_token')}<br>`;
  result += `Gist ID: ${!!localStorage.getItem('fl510_gist_id')}<br>`;
  
  document.getElementById('debug-basics-result').innerHTML = `<div class="debug-status">${result}</div>`;
}

async function debugTestToken() {
  const token = document.getElementById('debug-token').value.trim();
  if (!token) {
    document.getElementById('debug-token-result').innerHTML = '<div class="debug-error">è¯·è¾“å…¥Token</div>';
    return;
  }

  document.getElementById('debug-token-result').innerHTML = '<div class="debug-info">æ­£åœ¨æµ‹è¯•Token...</div>';

  try {
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': `token ${token}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (response.ok) {
      const user = await response.json();
      document.getElementById('debug-token-result').innerHTML = `<div class="debug-success">âœ… Tokenæœ‰æ•ˆï¼ç”¨æˆ·: ${user.login}</div>`;
      
      // ä¿å­˜Token
      localStorage.setItem('github_sync_token', token);
      if (window.configSync) {
        window.configSync.githubToken = token;
      }
    } else {
      document.getElementById('debug-token-result').innerHTML = `<div class="debug-error">âŒ Tokenæ— æ•ˆï¼ŒçŠ¶æ€ç : ${response.status}</div>`;
    }
  } catch (error) {
    document.getElementById('debug-token-result').innerHTML = `<div class="debug-error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
  }
}

async function debugTestSync() {
  document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">æ­£åœ¨æµ‹è¯•åŒæ­¥...</div>';
  
  try {
    if (window.configSync && window.configSync.syncConfig) {
      await window.configSync.syncConfig();
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-success">âœ… åŒæ­¥æµ‹è¯•å®Œæˆ</div>';
    } else {
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-error">âŒ configSyncä¸å¯ç”¨</div>';
    }
  } catch (error) {
    document.getElementById('debug-sync-result').innerHTML = `<div class="debug-error">âŒ åŒæ­¥å¤±è´¥: ${error.message}</div>`;
  }
}

async function debugTestLoad() {
  document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">æ­£åœ¨æµ‹è¯•åŠ è½½...</div>';
  
  try {
    if (window.configSync && window.configSync.loadConfig) {
      const config = await window.configSync.loadConfig();
      if (config) {
        document.getElementById('debug-sync-result').innerHTML = `<div class="debug-success">âœ… åŠ è½½æˆåŠŸ: ${JSON.stringify(config)}</div>`;
      } else {
        document.getElementById('debug-sync-result').innerHTML = '<div class="debug-info">âš ï¸ æ²¡æœ‰äº‘ç«¯é…ç½®</div>';
      }
    } else {
      document.getElementById('debug-sync-result').innerHTML = '<div class="debug-error">âŒ configSyncä¸å¯ç”¨</div>';
    }
  } catch (error) {
    document.getElementById('debug-sync-result').innerHTML = `<div class="debug-error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
  }
}

function debugAddUser() {
  try {
    let config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
    if (!config.allowedUsers) config.allowedUsers = [];
    if (!config.adminUsers) config.adminUsers = [];

    const testUser = 'test-user-' + Date.now();
    config.allowedUsers.push(testUser);
    
    localStorage.setItem('fl510_docs_config', JSON.stringify(config));
    
    if (window.AUTH_CONFIG) {
      window.AUTH_CONFIG.allowedUsers = config.allowedUsers;
    }

    document.getElementById('debug-config-result').innerHTML = `<div class="debug-success">âœ… æ·»åŠ æµ‹è¯•ç”¨æˆ·: ${testUser}</div>`;
  } catch (error) {
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-error">âŒ æ·»åŠ ç”¨æˆ·å¤±è´¥: ${error.message}</div>`;
  }
}

function debugShowConfig() {
  try {
    const config = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-info"><pre>${JSON.stringify(config, null, 2)}</pre></div>`;
  } catch (error) {
    document.getElementById('debug-config-result').innerHTML = `<div class="debug-error">âŒ æ˜¾ç¤ºé…ç½®å¤±è´¥: ${error.message}</div>`;
  }
}

function debugShowInfo() {
  let debug = 'è°ƒè¯•ä¿¡æ¯ï¼š<br><pre>';
  
  debug += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
  debug += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
  debug += `AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
  
  if (window.configSync) {
    debug += `setupSync: ${typeof window.configSync.setupSync}\n`;
    debug += `syncConfig: ${typeof window.configSync.syncConfig}\n`;
    debug += `loadConfig: ${typeof window.configSync.loadConfig}\n`;
    debug += `disableSync: ${typeof window.configSync.disableSync}\n`;
  }
  
  debug += '</pre>';
  document.getElementById('debug-info-result').innerHTML = `<div class="debug-info">${debug}</div>`;
}

// æ·»åŠ è°ƒè¯•æŒ‰é’®åˆ°å¯¼èˆª
function addDebugButton() {
  const nav = document.querySelector('.nav');
  if (nav && !document.getElementById('debug-btn')) {
    const debugBtn = document.createElement('button');
    debugBtn.id = 'debug-btn';
    debugBtn.textContent = 'ğŸ”§ è°ƒè¯•';
    debugBtn.style.cssText = 'position: fixed; top: 10px; right: 10px; z-index: 1000; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;';
    debugBtn.onclick = () => {
      const debugLayer = document.querySelector('[data-layer="debug"]');
      if (debugLayer) {
        debugLayer.style.display = debugLayer.style.display === 'none' ? 'block' : 'none';
      }
    };
    document.body.appendChild(debugBtn);
  }
}

// é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ è°ƒè¯•æŒ‰é’®
setTimeout(addDebugButton, 2000);

// è‡ªåŠ¨æ£€æŸ¥é…ç½®åŒæ­¥çŠ¶æ€
function checkConfigSyncStatus() {
  console.log('Checking config sync status...');
  
  // æ£€æŸ¥æ˜¯å¦æœ‰GitHub Token
  const hasToken = !!localStorage.getItem('github_sync_token');
  const hasGistId = !!localStorage.getItem('fl510_gist_id');
  
  console.log('Sync status:', { hasToken, hasGistId, configSync: !!window.configSync });
  
  // å¦‚æœé…ç½®åŒæ­¥å¯ç”¨ï¼Œå°è¯•ä»æœåŠ¡å™¨åŠ è½½é…ç½®
  if (window.configSync && window.configSync.initialized && hasToken) {
    console.log('Attempting to load config from server...');
    window.configSync.loadConfig().then(config => {
      if (config && (config.allowedUsers || config.adminUsers)) {
        console.log('Server config loaded:', config);
        
        // æ›´æ–°æœ¬åœ°é…ç½®
        const currentConfig = JSON.parse(localStorage.getItem('fl510_docs_config') || '{}');
        const mergedConfig = {
          allowedUsers: [...new Set([...(config.allowedUsers || []), ...(currentConfig.allowedUsers || [])])],
          adminUsers: [...new Set([...(config.adminUsers || []), ...(currentConfig.adminUsers || [])])]
        };
        
        localStorage.setItem('fl510_docs_config', JSON.stringify(mergedConfig));
        
        // æ›´æ–°å…¨å±€é…ç½®
        if (window.AUTH_CONFIG) {
          window.AUTH_CONFIG.allowedUsers = mergedConfig.allowedUsers;
          window.AUTH_CONFIG.adminUsers = mergedConfig.adminUsers;
        }
        
        console.log('Config merged and updated:', mergedConfig);
      }
    }).catch(error => {
      console.error('Failed to load config from server:', error);
    });
  }
}

// é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥é…ç½®åŒæ­¥çŠ¶æ€
setTimeout(checkConfigSyncStatus, 3000);
</script>

<!-- è°ƒè¯•æ ·å¼ -->
<style>
.debug-panel { max-width: 800px; margin: 0 auto; }
.debug-section { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
.debug-btn { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
.debug-result { margin: 10px 0; }
.debug-status, .debug-info { background: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; }
.debug-success { background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; }
.debug-error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; }
</style>

<!-- åŠ è½½è®¤è¯ç³»ç»Ÿ -->
<script src="javascripts/auth-config.js?v=2024-10-20"></script>
<script src="javascripts/auth.js?v=2024-10-20"></script>
<script src="javascripts/admin.js?v=2024-10-20"></script>
<script src="javascripts/github-users.js?v=2024-10-20"></script>

</body>
</html>
