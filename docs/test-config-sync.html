<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置同步功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 配置同步功能测试</h1>
    
    <div class="test-section">
        <h2>1. 基础检查</h2>
        <button class="test-button" onclick="checkBasicSetup()">检查基础设置</button>
        <div id="basic-status"></div>
    </div>

    <div class="test-section">
        <h2>2. 配置同步对象检查</h2>
        <button class="test-button" onclick="checkConfigSync()">检查ConfigSync对象</button>
        <div id="configsync-status"></div>
    </div>

    <div class="test-section">
        <h2>3. 初始化测试</h2>
        <button class="test-button" onclick="testInitialization()">测试初始化</button>
        <div id="init-status"></div>
    </div>

    <div class="test-section">
        <h2>4. 方法调用测试</h2>
        <button class="test-button" onclick="testMethods()">测试方法调用</button>
        <div id="methods-status"></div>
    </div>

    <div class="test-section">
        <h2>5. 手动初始化</h2>
        <button class="test-button" onclick="manualInit()">手动初始化</button>
        <div id="manual-status"></div>
    </div>

    <div class="test-section">
        <h2>6. 调试信息</h2>
        <button class="test-button" onclick="showDebugInfo()">显示调试信息</button>
        <div id="debug-info"></div>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/config-sync.js"></script>

    <script>
        function showStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function checkBasicSetup() {
            let status = '基础检查结果：<br>';
            
            // 检查必要的全局对象
            status += `window.AUTH_CONFIG: ${!!window.AUTH_CONFIG}<br>`;
            status += `window.configSync: ${!!window.configSync}<br>`;
            status += `initializeConfigSync函数: ${typeof window.initializeConfigSync}<br>`;
            
            // 检查localStorage
            const hasLocalConfig = !!localStorage.getItem('fl510_docs_config');
            status += `本地配置: ${hasLocalConfig}<br>`;
            
            // 检查GitHub token
            const hasGitHubToken = !!localStorage.getItem('github_sync_token');
            status += `GitHub Token: ${hasGitHubToken}<br>`;
            
            showStatus('basic-status', status, hasLocalConfig || hasGitHubToken ? 'success' : 'info');
        }

        function checkConfigSync() {
            let status = 'ConfigSync对象检查：<br>';
            
            if (!window.configSync) {
                showStatus('configsync-status', '❌ window.configSync 不存在', 'error');
                return;
            }
            
            status += `对象存在: ✅<br>`;
            status += `已初始化: ${window.configSync.initialized ? '✅' : '❌'}<br>`;
            status += `setupSync方法: ${typeof window.configSync.setupSync}<br>`;
            status += `syncConfig方法: ${typeof window.configSync.syncConfig}<br>`;
            status += `loadConfig方法: ${typeof window.configSync.loadConfig}<br>`;
            status += `disableSync方法: ${typeof window.configSync.disableSync}<br>`;
            
            const allMethodsExist = typeof window.configSync.setupSync === 'function' &&
                                  typeof window.configSync.syncConfig === 'function' &&
                                  typeof window.configSync.loadConfig === 'function' &&
                                  typeof window.configSync.disableSync === 'function';
            
            showStatus('configsync-status', status, allMethodsExist ? 'success' : 'error');
        }

        function testInitialization() {
            let status = '初始化测试：<br>';
            
            try {
                if (typeof window.initializeConfigSync === 'function') {
                    window.initializeConfigSync();
                    status += '✅ 初始化函数调用成功<br>';
                    status += `初始化状态: ${window.configSync.initialized ? '✅' : '❌'}<br>`;
                } else {
                    status += '❌ 初始化函数不存在<br>';
                }
            } catch (error) {
                status += `❌ 初始化失败: ${error.message}<br>`;
            }
            
            showStatus('init-status', status, window.configSync.initialized ? 'success' : 'error');
        }

        function testMethods() {
            let status = '方法调用测试：<br>';
            
            try {
                // 测试setupSync
                if (typeof window.configSync.setupSync === 'function') {
                    status += '✅ setupSync方法可调用<br>';
                } else {
                    status += '❌ setupSync方法不可用<br>';
                }
                
                // 测试loadConfig
                if (typeof window.configSync.loadConfig === 'function') {
                    status += '✅ loadConfig方法可调用<br>';
                } else {
                    status += '❌ loadConfig方法不可用<br>';
                }
                
            } catch (error) {
                status += `❌ 方法测试失败: ${error.message}<br>`;
            }
            
            showStatus('methods-status', status, 'info');
        }

        function manualInit() {
            let status = '手动初始化：<br>';
            
            try {
                // 强制重新初始化
                if (window.configSync) {
                    window.configSync.initialized = false;
                }
                
                if (typeof window.initializeConfigSync === 'function') {
                    window.initializeConfigSync();
                    status += '✅ 手动初始化完成<br>';
                    status += `当前状态: ${window.configSync.initialized ? '已初始化' : '未初始化'}<br>`;
                } else {
                    status += '❌ 初始化函数不可用<br>';
                }
            } catch (error) {
                status += `❌ 手动初始化失败: ${error.message}<br>`;
            }
            
            showStatus('manual-status', status, window.configSync.initialized ? 'success' : 'error');
        }

        function showDebugInfo() {
            let debugInfo = '调试信息：<br><pre>';
            
            debugInfo += `window.configSync: ${JSON.stringify(window.configSync, null, 2)}\n\n`;
            debugInfo += `window.AUTH_CONFIG: ${JSON.stringify(window.AUTH_CONFIG, null, 2)}\n\n`;
            debugInfo += `localStorage keys: ${Object.keys(localStorage).join(', ')}\n\n`;
            debugInfo += `document.readyState: ${document.readyState}\n\n`;
            debugInfo += `navigator.userAgent: ${navigator.userAgent}\n`;
            
            debugInfo += '</pre>';
            
            showStatus('debug-info', debugInfo, 'info');
        }

        // 页面加载完成后自动检查
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkBasicSetup();
                checkConfigSync();
            }, 1000);
        });
    </script>
</body>
</html>
