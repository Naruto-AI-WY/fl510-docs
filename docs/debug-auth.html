<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
        }
        .status-value {
            color: #666;
        }
        .status-value.success {
            color: #28a745;
        }
        .status-value.error {
            color: #dc3545;
        }
        .status-value.warning {
            color: #ffc107;
        }
        .debug-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .debug-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-btn:hover {
            background: #0056b3;
        }
        .debug-btn.danger {
            background: #dc3545;
        }
        .debug-btn.danger:hover {
            background: #c82333;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔧 认证系统调试页面</h1>
    
    <div class="debug-section">
        <h3>📊 认证状态</h3>
        <div id="auth-status">
            <div class="status-item">
                <span class="status-label">认证状态:</span>
                <span class="status-value" id="auth-status-value">检查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">用户信息:</span>
                <span class="status-value" id="user-info-value">检查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">管理员权限:</span>
                <span class="status-value" id="admin-status-value">检查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">认证过期时间:</span>
                <span class="status-value" id="expiry-value">检查中...</span>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3>🔧 调试操作</h3>
        <div class="debug-actions">
            <button class="debug-btn" onclick="refreshStatus()">🔄 刷新状态</button>
            <button class="debug-btn" onclick="testLogin()">🧪 测试登录</button>
            <button class="debug-btn" onclick="clearAuth()">🗑️ 清除认证</button>
            <button class="debug-btn danger" onclick="clearAllData()">⚠️ 清除所有数据</button>
        </div>
    </div>

    <div class="debug-section">
        <h3>📝 配置信息</h3>
        <div id="config-info">
            <div class="status-item">
                <span class="status-label">允许的用户:</span>
                <span class="status-value" id="allowed-users-value">检查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">管理员用户:</span>
                <span class="status-value" id="admin-users-value">检查中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">存储键:</span>
                <span class="status-value" id="storage-key-value">检查中...</span>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3>📋 控制台日志</h3>
        <div class="log-output" id="console-log">等待日志...</div>
    </div>

    <div class="debug-section">
        <h3>🔗 快速链接</h3>
        <div class="debug-actions">
            <a href="/" class="debug-btn" style="text-decoration: none; display: inline-block;">🏠 返回主页</a>
            <a href="/services/calibration/ph_calibration_requirements_v1.6.7/" class="debug-btn" style="text-decoration: none; display: inline-block;">📄 pH校准文档</a>
            <a href="/test-auth.html" class="debug-btn" style="text-decoration: none; display: inline-block;">🧪 认证测试</a>
        </div>
    </div>

    <!-- 加载认证脚本 -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/auth.js"></script>
    <script src="javascripts/admin.js"></script>

    <script>
        // 重定向控制台日志到页面
        const originalLog = console.log;
        const originalError = console.error;
        const logOutput = document.getElementById('console-log');
        
        function addToLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };

        // 刷新状态
        function refreshStatus() {
            console.log('Refreshing authentication status...');
            
            // 检查认证状态
            const isAuthenticated = window.checkAuthStatus ? window.checkAuthStatus() : false;
            const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
            
            // 更新认证状态
            const authStatusEl = document.getElementById('auth-status-value');
            if (isAuthenticated) {
                authStatusEl.textContent = '已认证';
                authStatusEl.className = 'status-value success';
            } else {
                authStatusEl.textContent = '未认证';
                authStatusEl.className = 'status-value error';
            }
            
            // 更新用户信息
            const userInfoEl = document.getElementById('user-info-value');
            if (currentUser) {
                userInfoEl.textContent = `${currentUser.login} (${currentUser.name || 'N/A'})`;
                userInfoEl.className = 'status-value success';
            } else {
                userInfoEl.textContent = '无';
                userInfoEl.className = 'status-value error';
            }
            
            // 更新管理员状态
            const adminStatusEl = document.getElementById('admin-status-value');
            if (window.githubAuth && window.githubAuth.isAdmin) {
                adminStatusEl.textContent = '是';
                adminStatusEl.className = 'status-value success';
            } else {
                adminStatusEl.textContent = '否';
                adminStatusEl.className = 'status-value warning';
            }
            
            // 更新过期时间
            const expiryEl = document.getElementById('expiry-value');
            const authData = localStorage.getItem(window.AUTH_CONFIG?.authStorageKey || 'fl510_docs_auth');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    if (parsed.expiresAt) {
                        const expiryDate = new Date(parsed.expiresAt);
                        expiryEl.textContent = expiryDate.toLocaleString();
                        expiryEl.className = 'status-value success';
                    } else {
                        expiryEl.textContent = '无过期时间';
                        expiryEl.className = 'status-value warning';
                    }
                } catch (e) {
                    expiryEl.textContent = '解析错误';
                    expiryEl.className = 'status-value error';
                }
            } else {
                expiryEl.textContent = '无认证数据';
                expiryEl.className = 'status-value error';
            }
            
            // 更新配置信息
            if (window.AUTH_CONFIG) {
                document.getElementById('allowed-users-value').textContent = window.AUTH_CONFIG.allowedUsers?.join(', ') || '无';
                document.getElementById('admin-users-value').textContent = window.AUTH_CONFIG.adminUsers?.join(', ') || '无';
                document.getElementById('storage-key-value').textContent = window.AUTH_CONFIG.authStorageKey || '无';
            }
        }
        
        // 测试登录
        function testLogin() {
            console.log('Testing login...');
            if (window.githubAuth) {
                const username = prompt('请输入GitHub用户名进行测试:');
                if (username) {
                    // 模拟手动认证
                    fetch(`https://api.github.com/users/${username}`)
                        .then(response => response.json())
                        .then(user => {
                            console.log('GitHub API response:', user);
                            if (window.githubAuth.handleSuccessfulAuth) {
                                window.githubAuth.handleSuccessfulAuth(user);
                                setTimeout(refreshStatus, 1000);
                            }
                        })
                        .catch(error => {
                            console.error('Login test failed:', error);
                            alert('登录测试失败: ' + error.message);
                        });
                }
            } else {
                alert('认证系统未初始化');
            }
        }
        
        // 清除认证
        function clearAuth() {
            console.log('Clearing authentication...');
            if (window.AUTH_CONFIG) {
                localStorage.removeItem(window.AUTH_CONFIG.authStorageKey);
            }
            if (window.githubAuth) {
                window.githubAuth.logout();
            }
            setTimeout(refreshStatus, 500);
        }
        
        // 清除所有数据
        function clearAllData() {
            if (confirm('确定要清除所有本地数据吗？这将包括认证信息、设置等。')) {
                console.log('Clearing all local data...');
                localStorage.clear();
                sessionStorage.clear();
                setTimeout(refreshStatus, 500);
            }
        }
        
        // 页面加载时自动刷新状态
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(refreshStatus, 1000);
        });
    </script>
</body>
</html>