<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯è°ƒè¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: bold;
        }
        .status-value {
            color: #666;
        }
        .status-value.success {
            color: #28a745;
        }
        .status-value.error {
            color: #dc3545;
        }
        .status-value.warning {
            color: #ffc107;
        }
        .debug-actions {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .debug-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .debug-btn:hover {
            background: #0056b3;
        }
        .debug-btn.danger {
            background: #dc3545;
        }
        .debug-btn.danger:hover {
            background: #c82333;
        }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ è®¤è¯ç³»ç»Ÿè°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <h3>ğŸ“Š è®¤è¯çŠ¶æ€</h3>
        <div id="auth-status">
            <div class="status-item">
                <span class="status-label">è®¤è¯çŠ¶æ€:</span>
                <span class="status-value" id="auth-status-value">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç”¨æˆ·ä¿¡æ¯:</span>
                <span class="status-value" id="user-info-value">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç®¡ç†å‘˜æƒé™:</span>
                <span class="status-value" id="admin-status-value">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">è®¤è¯è¿‡æœŸæ—¶é—´:</span>
                <span class="status-value" id="expiry-value">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3>ğŸ”§ è°ƒè¯•æ“ä½œ</h3>
        <div class="debug-actions">
            <button class="debug-btn" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            <button class="debug-btn" onclick="testLogin()">ğŸ§ª æµ‹è¯•ç™»å½•</button>
            <button class="debug-btn" onclick="clearAuth()">ğŸ—‘ï¸ æ¸…é™¤è®¤è¯</button>
            <button class="debug-btn danger" onclick="clearAllData()">âš ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“ é…ç½®ä¿¡æ¯</h3>
        <div id="config-info">
            <div class="status-item">
                <span class="status-label">å…è®¸çš„ç”¨æˆ·:</span>
                <span class="status-value" id="allowed-users-value">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç®¡ç†å‘˜ç”¨æˆ·:</span>
                <span class="status-value" id="admin-users-value">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å­˜å‚¨é”®:</span>
                <span class="status-value" id="storage-key-value">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h3>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h3>
        <div class="log-output" id="console-log">ç­‰å¾…æ—¥å¿—...</div>
    </div>

    <div class="debug-section">
        <h3>ğŸ”— å¿«é€Ÿé“¾æ¥</h3>
        <div class="debug-actions">
            <a href="/" class="debug-btn" style="text-decoration: none; display: inline-block;">ğŸ  è¿”å›ä¸»é¡µ</a>
            <a href="/services/calibration/ph_calibration_requirements_v1.6.7/" class="debug-btn" style="text-decoration: none; display: inline-block;">ğŸ“„ pHæ ¡å‡†æ–‡æ¡£</a>
            <a href="/test-auth.html" class="debug-btn" style="text-decoration: none; display: inline-block;">ğŸ§ª è®¤è¯æµ‹è¯•</a>
        </div>
    </div>

    <!-- åŠ è½½è®¤è¯è„šæœ¬ -->
    <script src="javascripts/auth-config.js"></script>
    <script src="javascripts/auth.js"></script>
    <script src="javascripts/admin.js"></script>

    <script>
        // é‡å®šå‘æ§åˆ¶å°æ—¥å¿—åˆ°é¡µé¢
        const originalLog = console.log;
        const originalError = console.error;
        const logOutput = document.getElementById('console-log');
        
        function addToLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };

        // åˆ·æ–°çŠ¶æ€
        function refreshStatus() {
            console.log('Refreshing authentication status...');
            
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            const isAuthenticated = window.checkAuthStatus ? window.checkAuthStatus() : false;
            const currentUser = window.getCurrentUser ? window.getCurrentUser() : null;
            
            // æ›´æ–°è®¤è¯çŠ¶æ€
            const authStatusEl = document.getElementById('auth-status-value');
            if (isAuthenticated) {
                authStatusEl.textContent = 'å·²è®¤è¯';
                authStatusEl.className = 'status-value success';
            } else {
                authStatusEl.textContent = 'æœªè®¤è¯';
                authStatusEl.className = 'status-value error';
            }
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            const userInfoEl = document.getElementById('user-info-value');
            if (currentUser) {
                userInfoEl.textContent = `${currentUser.login} (${currentUser.name || 'N/A'})`;
                userInfoEl.className = 'status-value success';
            } else {
                userInfoEl.textContent = 'æ— ';
                userInfoEl.className = 'status-value error';
            }
            
            // æ›´æ–°ç®¡ç†å‘˜çŠ¶æ€
            const adminStatusEl = document.getElementById('admin-status-value');
            if (window.githubAuth && window.githubAuth.isAdmin) {
                adminStatusEl.textContent = 'æ˜¯';
                adminStatusEl.className = 'status-value success';
            } else {
                adminStatusEl.textContent = 'å¦';
                adminStatusEl.className = 'status-value warning';
            }
            
            // æ›´æ–°è¿‡æœŸæ—¶é—´
            const expiryEl = document.getElementById('expiry-value');
            const authData = localStorage.getItem(window.AUTH_CONFIG?.authStorageKey || 'fl510_docs_auth');
            if (authData) {
                try {
                    const parsed = JSON.parse(authData);
                    if (parsed.expiresAt) {
                        const expiryDate = new Date(parsed.expiresAt);
                        expiryEl.textContent = expiryDate.toLocaleString();
                        expiryEl.className = 'status-value success';
                    } else {
                        expiryEl.textContent = 'æ— è¿‡æœŸæ—¶é—´';
                        expiryEl.className = 'status-value warning';
                    }
                } catch (e) {
                    expiryEl.textContent = 'è§£æé”™è¯¯';
                    expiryEl.className = 'status-value error';
                }
            } else {
                expiryEl.textContent = 'æ— è®¤è¯æ•°æ®';
                expiryEl.className = 'status-value error';
            }
            
            // æ›´æ–°é…ç½®ä¿¡æ¯
            if (window.AUTH_CONFIG) {
                document.getElementById('allowed-users-value').textContent = window.AUTH_CONFIG.allowedUsers?.join(', ') || 'æ— ';
                document.getElementById('admin-users-value').textContent = window.AUTH_CONFIG.adminUsers?.join(', ') || 'æ— ';
                document.getElementById('storage-key-value').textContent = window.AUTH_CONFIG.authStorageKey || 'æ— ';
            }
        }
        
        // æµ‹è¯•ç™»å½•
        function testLogin() {
            console.log('Testing login...');
            if (window.githubAuth) {
                const username = prompt('è¯·è¾“å…¥GitHubç”¨æˆ·åè¿›è¡Œæµ‹è¯•:');
                if (username) {
                    // æ¨¡æ‹Ÿæ‰‹åŠ¨è®¤è¯
                    fetch(`https://api.github.com/users/${username}`)
                        .then(response => response.json())
                        .then(user => {
                            console.log('GitHub API response:', user);
                            if (window.githubAuth.handleSuccessfulAuth) {
                                window.githubAuth.handleSuccessfulAuth(user);
                                setTimeout(refreshStatus, 1000);
                            }
                        })
                        .catch(error => {
                            console.error('Login test failed:', error);
                            alert('ç™»å½•æµ‹è¯•å¤±è´¥: ' + error.message);
                        });
                }
            } else {
                alert('è®¤è¯ç³»ç»Ÿæœªåˆå§‹åŒ–');
            }
        }
        
        // æ¸…é™¤è®¤è¯
        function clearAuth() {
            console.log('Clearing authentication...');
            if (window.AUTH_CONFIG) {
                localStorage.removeItem(window.AUTH_CONFIG.authStorageKey);
            }
            if (window.githubAuth) {
                window.githubAuth.logout();
            }
            setTimeout(refreshStatus, 500);
        }
        
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿè¿™å°†åŒ…æ‹¬è®¤è¯ä¿¡æ¯ã€è®¾ç½®ç­‰ã€‚')) {
                console.log('Clearing all local data...');
                localStorage.clear();
                sessionStorage.clear();
                setTimeout(refreshStatus, 500);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(refreshStatus, 1000);
        });
    </script>
</body>
</html>